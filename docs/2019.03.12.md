# 客户端消息订阅机制

客户端消息订阅机制，为客户端通过 Web Socket 连接订阅、退订业务消息提供了便捷接口

@note 订阅/退订/推送都是基于 WebSocket 接口实现的

## 消息的定义

@note 在订阅/退订/推送中，所使用的事件名称都是一致的，例如 p2p/transaction, p2p/headers

## 消息的订阅和退订

客户端通过如下指令，通知服务端订阅消息

```js
//引入工具包
const toolkit = require('gamegoldtoolkit')

//创建授权式连接器实例
const remote = new toolkit.conn();

//将连接器设置为WS模式
remote.setmode(remote.CommMode.ws)

//执行登录等长连必备流程
await remote.login();
await remote.join();

//发送指令订阅消息 'prop.receive'，并通过 watch 函数为同名消息指定处理句柄
remote.watch(msg => {
        console.log(msg);
    }, 'prop/receive');
await remote.execute('subscribe', ['prop/receive']);

//如下消息为默认发送，不需要事先订阅
remote.watch(msg => {
    console.log('tx.client', msg);
}, 'tx.client');

remote.watch(msg => {
    console.log('balance.account.client', msg);
}, 'balance.account.client');

remote..watch(msg => {
    console.log('balance.client', msg);
}, 'balance.client');
```

客户端通过如下指令，通知服务端退订消息

```js
await remote.execute('unsubscribe', ['prop/receive']);
```

全节点通过如下代码，监听客户端上行订阅/退订指令

```js
socket.hook('subscribe', function(args) {
    bus.subscribe(args[0]);
    return true;
});

socket.hook('unsubscribe', function(args) {
    bus.unsubscribe(args[0]);
    return true;
});
```

## 消息的推送

全节点向订阅消息的所有客户端推送消息

```js
const {broadcast} = require('/lib/rpc/event/index')

//指定消息名称、消息体(JSON Object)，向全体订阅者推送消息
broadcast('prop.receive', {});
```

## 可用消息列表

11. *tx.client: 收到新的交易

```json
{ 
    "wid":              "钱包编号",
    "id":               "钱包名称",
    "hash":             "交易哈希",
    "height":           "交易高度",
    "block":            "区块信息",
    "date":             "交易时间格式化串",
    "size":             "交易尺寸",
    "confirmations":    "确认数",
    "inputs": [ 
        { 
            "value":    "输入数值",
            "address":  "输入地址",
        } 
    ],
    "outputs": [ 
        { 
            "value":    "输出数值",
            "address":  "输出地址",
        } 
    ]
}
```

12. *balance.account.client: 子账户余额变动通知

```json
{ 
    "wid":          "钱包编号",
    "id":           "钱包名称",
    "account":      "账号编号",
    "accountName":  "账号名称",
    "unconfirmed":  "未确认余额",
    "confirmed":    "已确认余额" 
}
```

13. *balance.client: 账户余额变动通知

```json
{ 
    "wid":          "钱包编号",
    "id":           "钱包名称",
    "unconfirmed":  "未确认余额",
    "confirmed":    "已确认余额" 
}
```

@note 星标消息默认发送，不用事先订阅

21. prop/receive: 收到新的道具，或者已有道具发生变更

```json
{
    "pid": "道具编号",
    "address": "道具地址",
    "wid": "道具归属钱包编号",
    "account": "道具归属钱包账号",
}
```
