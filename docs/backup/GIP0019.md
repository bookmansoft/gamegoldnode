# GIP0019 游戏众筹的实现机制
Layer: Contract
Title: Crowd-funding
Status: Draft V0.1
Author：bookman
Type: Standards Track
Created: 2018-12-19
Summary：采用二层染色币机制，实现通用游戏众筹业务流程

## 概述

本规范描述了一种为单个游戏发行可分割权益凭证的方法，权益凭证支持首发、转让、续发，持有量将作为游戏流水分成的官方依据。

本规范实现并发布后，原有的基于道具模型的CP权益凭证机制仍旧保留。其中本规范对标 ERC20 ，而原有的基于道具模型的CP权益凭证则对标 ERC721

最终的权益凭证模型为：
1. 20% 为CP身份持有人持有，媒体分成（0 <= val < 20）从该部分扣除
2. 30% 以基于道具模式的CP权益凭证发行：发行30个权益道具，每个代表1%权益
3. 50% 以GIP0019模式的权益凭证发行

## 凭证管理对象

整体上来看，可以将P2P视为系统的接入层，将RPC看作视图层，智能合约层可以视为控制层，系统逻辑层可以视为彼此关联的若干状态机，最后是基于KV数据库的持久层

凭证信息由RPC层输入，经过P2P传播，通过智能合约解读后，分发到凭证管理对象

由凭证管理对象管理的凭证信息分为如下类型：

1. 汇总信息：在每个凭证条目下，记录每个凭证的首发高度、历史发行总额、发行均价、累计分成、累计推广分成、当前发行余额、当前发行价、当前发行高度等汇总信息
2. 流水信息：每一次的发行信息，每一次的购买信息，每一次的转让信息
3. 账户信息：以地址为账户索引，记录每个账户的凭证余额

注：汇总信息将合并至CP条目上，并共享CP管理相关的功能接口
注：所有的凭证信息，必须以上链信息为准（确认数大于等于1）

凭证对象提供的动作包括：

1. 记录一次发行行为
2. 记录一次购买行为
3. 记录一次转让行为
4. 记录一次流水分成行为

在动作发生时，凭证对象负责统一处理汇总信息、流水信息、账户信息的变动

凭证对象提供的查询包括：

1. 指定账户地址，查询其余额、建仓成本、累计分成
2. 指定CP编号，查询CP的凭证汇总信息
3. 指定符合筛选条件的流水信息列表

凭证对象提供的事件通知包括（同时面向node和wallet）：

1. 发生了一个凭证发行行为
2. 发生了一个凭证购买行为
3. 发生了一个转让行为
4. 获取了一笔新的分成

注：所有行为的合法性判定流程，在控制层也就是智能合约层实现

## 交易类型分析

### 凭证发行交易

CP通过签发一个凭证发行交易，对外宣布了一笔报价、数额确定的凭证发行业务：

1. √ CP可以多次发行凭证，当前发行信息计入CP词条下，包括发行高度、本次最大发行数量、发行价格（单位尘），发行记录逐次记录日志
2. √ 单次发行周期为2016个区块，在发行期限内成功销售的凭证转为记账凭证并参与流水分成(未销售出去的凭证的相关权益自动留存于CP拥有者，无需额外计算)
3. √ 在上一次发行截止后，记账凭证未达总量限额时，可以再次发行，但必须等待至少2016个区块，且累计**有效分成**超过总发行币值的10%
4. √ 累计有效发行总量不能超过1000万，单次发行数量大于零且不能超过100万
5. √ 发行交易上链后，CP词条上会更新记录当前可购买凭证数量、购买价格、总发行量、总发行币值
6. √ 凭证持有人总共享有50%的流水分成，按照每个地址的实际持有量进行等额分配
7. √ 只有CP持有人才能发起发行交易
8. √ 每次发行需要支付发行总量5%的手续费，作为矿工和优质CP收入的一部分
9. √ 最高发行价不能大于0.05游戏金，续发价格不能低于上次发行价，也不能超过上次发行价的4倍

注：**有效分成**是按照实际分成记录中的币天值折算而来，计算公式如下：
1. 落差大于2016个区块以上，币天值 = 币值*3.75*(落差/2016)^0.5
2. 落差在144～2016个区块之间，币天值 = 币值*(落差/144)^0.5
3. 落差在6～143个区块以内，币天值 = 币值*0.2*(落差/6)^0.5
4. 落差小于6，币天值 = 币值*0.08*落差^0.5

限制规则总结如下：
1. 时间限制：发行有效期和再次发行冷却期都是2016个高度(两周时间)
2. 数量限制：单次发行量和总量受限，发行价跌幅涨幅受限，最高发行价受限
3. 业绩限制：有效分成未达标不得续发
4. 成本限制：单次发行必须一次性支付发行总量5%的手续费

凭证发行交易的数据结构
```json
[
    "inputs":[
        {"Fee Input"}       //支付给矿工
    ],
    "outputs":[
        {
            "scripts":[
                "OP_RETURN",
                {
                    "交易类型":     "stock",
                    "交易编号":     "一个全局唯一的随机编码",
                    "交易高度":     "交易发行时的块链高度",
                    "交易数据":     {
                        "凭证标识":     "必须是一个合法的CPID",
                        "操作类型":     "offer",
                        "凭证数量":     "可供购买的凭证的最大数量",
                        "凭证单价":     "第三方购买凭证的单价，以游戏金尘为单位"
                    }
                }
            ]
        },
        {"Charge Output"}       //找零
    ]
]
```

### 凭证购买交易

在凭证发行交易的有效期内，购买者可以发布一个凭证购买交易，系统将其与凭证发行交易进行比对，合规后允许传播并上链，购买者由此成为凭证的合规拥有者

1. 钱包用户可以通过如下指令主动查询当前所有在售凭证列表，选取进行购买

```bash
# 输入CP编号、记录类型，查询并返回记录列表
stock.record type cid
```

2. 凭证购买交易上链后，将在全节点上形成一条购买记录，同时在钱包中也形成一条购买记录
3. 购买交易将更新凭证持有列表的信息，包括持有量和建仓成本
4. 购买凭证数量100起，以避免粉尘交易攻击

购买凭证交易的数据结构
```json
{
    "inputs":[
        {"Fee Input"}
    ],
    "outputs":[
        {
            "scripts":[
                "OP_RETURN",
                {
                    "交易类型":     "stock",
                    "交易编号":     "一个全局唯一的随机编码",
                    "交易高度":     "交易发行时的块链高度",
                    "交易数据":     {
                        "交易编号":     "一个全局唯一的随机编码, 用于标识从哪个发行单据进行购买",
                        "操作类型":     "purchase",
                        "凭证数量":     "准备购买的凭证数量"
                    }
                }
            ]
        },
        {"Purchase Output"},    //支付到CP的法定地址
        {"Charge Output"}       //找零
    ]
}
```

验证流程：
1. 交易编号必须是指向一个有效的发行或拍卖记录
2. "Pruchase Input"必须足够支付购买总额，以及必要的矿工手续费
3. 购买数量不能超过发行总额

### 转让凭证交易

1. 凭证拥有者可以将成熟的凭证(持有时间必须超过144个块)转让给第三者
2. 凭证转让交易上链后，将在全节点上形成一条转让记录，同时在出让者、受让者钱包中同时形成一条转让记录
3. 转让凭证数量100起，以避免粉尘交易攻击

转让凭证交易的数据结构
```json
{
    "inputs":[
        {"Fee Input"}
    ],
    "outputs":[
        {
            "scripts":[
                "OP_RETURN",
                {
                    "交易类型":     "stock",
                    "交易编号":     "一个全局唯一的随机编码",
                    "交易高度":     "交易发行时的块链高度",
                    "交易数据":     {
                        "凭证标识":     "必须是一个合法的CPID",
                        "数据类型":     "send",
                        "凭证数量":     "转让的凭证数量",
                        "发起地址":     "",
                        "受让地址":     "",
                    }
                }
            ]
        },
        {"Charge Output"}       //找零
    ]
}
```

## 凭证相关信息的存储模式

全节点：
1. 全节点将在CP词条下，记录凭证汇总信息
2. 全节点将逐条记录历次购买记录、转让记录
3. 全节点可以根据转让记录汇总成凭证持有总表，从而支撑流水分成业务

钱包：
1. 钱包将在CP词条下，记录凭证汇总信息
2. 钱包将逐条记录己方的历次购买记录、转让记录
2. 钱包可以根据购买记录、转让记录汇总成个人凭证持有列表

## API设计
注：当前版本支持凭证的发行、购买、无偿转让、有偿转让等业务模式
注：1、2为CP相关接口，与凭证管理共享

1. cp.query             CP列表，显示记账凭证总量，以及当前可发行数量、发行价格、发行期限等信息
2. cp.byId              凭证详情
3. stock.offer          发行凭证
4. stock.purchase       购买发行的凭证
5. stock.send           无偿转让凭证
6. stock.bid            有偿转让凭证，限定额度内和有效时间窗口期内，他人可以按照指定价格购买
7. stock.auction        购买有偿转让的凭证
8. stock.list           我持有的凭证列表，可显示持有量、持有比例、平均成本等信息，转让时按照平均成本计入受让者列表，支持分页
9. stock.record         查询凭证流水


## 合约检测结果码
```js
const verifyCode = {
    Failed: 0,                              //失败
    Success: 1,                             //成功
    StockOffering: 1001,                    //处于发行期，不能再次发售
    StockCooling: 1002,                     //处于冷却期，不能再次发售
    WrongPrice: 1003,                       //不当的价格
    WrongFee: 1004,                         //不当的税费
    WrongPublisher: 1005,                   //错误的发布者
    WrongSum: 1006,                         //凭证数量不合理
    WrongBonus: 1007,                       //累计奖励不足，不能再次发行
    SnapNull: 1008,                         //凭证快照不存在
    SignFailed: 1009,                       //签名错误
    WrongHeight: 1010,                      //错误的高度值
    WrongFormat: 1011,                      //错误的格式
    StockAccountNotExist: 1012,             //凭证账户不存在
    StockAccountNotEnoughSum: 1013,         //凭证账户余额不足
    StockOfferExpired: 1014,                //凭证发行已过期
    FundNotEnough: 1015,                    //资金不足
};
```
