# 使用手册

## 安装手册

1. 部署运行环境

- 硬件列表
PC服务器(Intel SkyLake 6161 2.2GHz 4核，8G内存，带宽5M，拥有公网IP)

- 软件列表
操作系统: Windows Server 2019
运行环境: Nodejs@12.20.0
**Windows平台下，安装过程中请勾选'Automatically install the necessary tools'以自动安装辅助工具**
开源项目库: https://github.com/bookmansoft/gamegoldnode
**本软件为数据引擎类软件，仅含服务端软件，不含客户端软件，对外开放远程调用接口(RPC)与第三方软件交互，可根据第三方要求定制开发配套SDK**
单元测试套件：Mocha@5.2.0

选择如下任意一款软硬件平台，可以基于本地部署模式或云端模式：
- 在PC(X86 64位 4核8G)上安装[Windows10]
- 在PC服务器(X86 64位 4核8G)上部署[Windows Server 2019]

在选定软硬件平台上安装Node的指定版本: Nodejs@12.20.3
**Nodejs@14.x或更高版本对部分依赖库兼容性不佳，所以请安装指定版本**

**兼容性声明** 
- 在PC服务器(X86 64位 4核8G)上部署[CentOS 7.6]
- 在华为鲲鹏服务器(Kunpeng 920 4核8G)上部署[EulerOS 2.8 64bit with ARM]

2. 克隆代码库

在运行主机上建立专门的管理目录，并确保运行主机处于联网状态

行命令模式下，进入管理目录，执行如下命令：

```bash
# 克隆项目代码库
git clone https://github.com/bookmansoft/gamegoldnode
# 进入项目目录
cd gamegoldnode
```

命令执行结束后，当前目录为项目根目录 ./gamegoldnode

3. 配置依赖项

行命令模式下，确保处于项目根目录下，执行如下命令：

```bash
# 安装依赖项
npm i
# 生成快捷指令链接
npm link
```

3. 启动节点

行命令模式下，确保处于项目根目录下，执行如下命令：

```bash
npm start
```

验证节点正常运行：

```bash
vc sys.info
```

## 维护手册

在 Windows10 或 WindowsServer2019 下依序执行如下操作：

1. 行命令模式下，确保进入项目根目录，并确保主机处于联机状态。如项目已在运行，将项目进程调度到前台，连续两次按 Ctrl+C 组合键，中断当前项目运行并回到行命令模式。

2. 更新项目代码仓库

```bash
# 将项目仓库升级到最新版本
git pull
# 更新依赖项
npm update
```

3. 重新启动项目进程

```bash
npm start
```

## 用户手册

1. 编写目的

本手册的目标阅读用户为《百谷王链》的潜在用户，如希望上线全新区块链项目或对传统信息系统进行链改的企事业单位。
本手册帮助用户快速了解《百谷王链》的背景、适用范围及相关定义说明，以确定该系统功能范畴和授权模式是否符合用户需要，或以何种方式快速开展应用。

2. 背景

本手册所描绘的软件系统，指福州百谷王网络科技公司自主研发的《百谷王链》，它是一种基于新型密码学基础之上的开源分布式数据库。第一批用户包括新大陆股份、联想(北京)、福建省标准化研究院等企业/科研机构。《百谷王链》正在与华为公司合作部署基于SaaS模式的区块链云服务，以进一步降低用户使用门槛。

3. 授权协议

《百谷王链》遵循MIT开源协议，其名称源自麻省理工学院（Massachusetts Institute of Technology, MIT），又称「X条款」（X License）或「X11条款」（X11 License）
MIT内容与三条款BSD许可证（3-clause BSD license）内容颇为近似，但是赋予软件被授权人更大的权利与更少的限制。被授权人有权利免费使用、复制、修改、合并、出版发行、散布、再授权及贩售软件及软件的副本。被授权人可根据程式的需要修改授权条款为适当的内容。在软件和软件的所有副本中都必须包含版权声明和许可声明。
MIT条款可与其他授权条款并存。

4. 适用范围

《百谷王链》适用于传统信息系统链改项目或新建区块链项目，为上述项目提供分布式身份认证、安全多方计算、预言机、智能合约引擎、跨链等特性功能的底层支撑:
- 支持全国产化软硬件开发/运行环境，如华为鲲鹏ARM芯片架构和华为欧拉操作系统。本软件已通过华为鲲鹏技术兼容性认证。
- 由可拔插共识层提供高度灵活性，可满足公链/联盟链/私链等多种场景下的技术开发需要。
- 提供功能完备的智能合约引擎，可作为各类商业逻辑适配上链的二次开发接口。

5. 参考资料

- 《百谷王链产品白皮书》
- 《Bitcoin: A Peer-to-Peer Electronic Cash System》
- 《Libra_WhitePaperV2》
- 《金融分布式账本技术安全规范》
- 《北京市政务服务领域区块链应用创新蓝皮书》

## 操作手册

《百谷王链》是一种基于新型密码学的分布式数据库，可基于多种模式与其交互：

一. 行命令操作模式

1. 启动控制台窗口，确保进入项目根目录，运行如下指令启动一个单节点

```bash
npm start
```

2. 启动另一个控制台窗口，运行如下指令，执行各种系统支持的功能指令

```bash
# 获取行命令工具常用命令列表
vc ?
# 获取RPC接口列表
vc help
# 调用记账功能，生成 100 个新的区块，注意每生成一个区块，系统账户将增加一定数量的通证
vc miner.generate.admin 100
# 生成一个新账户，同时生成该账户下的一个新地址，可以为同一个账户生成不限数量的新地址
vc address.create bookman
# 向指定地址转账。注意调用接口中的通证单位使用Dust(尘)，系统内部自动转换为VC(维, 1维=10^8尘)
vc tx.send tb1q0h3thutw4jl6hrse59493nkeg36he7dkgnt8lg 1000
# 查询指定账户的通证余额
vc balance.all bookman
```

二. 远程过程调用模式

百谷王链(Vallnet Blockchain Engine)提供了功能完备的远程调用接口，为第三方软件服务商集成区块链功能提供便利。下面分别从安全连接、接口描述(功能说明和出入参数)、功能测试等方面展开详细描述。

1. 术语解释

- FN：百谷王区块链引擎核心组件，又称全节点(Full Node)，独立运行于后台服务器或云主机上，可通过对等网络组网技术，和其它遵循兼容共识的FN一道构成可无限水平扩展的链库。
- VR: Vallnet RPC(百谷王链远程调用接口)的简称
- HMAC: 一种密钥分发机制，大幅降低了中间人攻击风险
- 终端: 指代尝试通过VR和FN交互的外部信息系统
- 上行报文签名：接口报文(Post Body)中的必填字段

2. 安全连接
    21. 基础校验
    VR调用中，必须在 Post Headers 中填写[Authorization]字段, 它由如下参数通过Base64转换而成：
    - "Username": "bitcoinrpc"
    - "Password": "bookmansoft"
    其中 Username Password 等字段必须与FN配置相一致
    可以在工具软件[Postman]中设置Authorization相关参数，软件会自动处理包含对应Headers字段值
    也可使用如下代码生成:
    ```js
        let username = 'bitcoinrpc', password = 'bookmansoft';
        const auth = `${username}:${password}`;
        const data = Buffer.from(auth, 'utf8');
        headers['Authorization'] = `Basic ${data.toString('base64')}`;
    ```

    22. HMAC
    VR采用HMAC算法避免中间人攻击(MITM), dev-mode下可忽略:
    - 全节点为终端制作证书并离线分发给终端，证书含[终端号]+[令牌尾]。注意证书信息不能泄露给第三方
    - 终端向全节点发起在线请求并上传[终端号]，全节点生成随机[令牌头]下发给终端。注意[令牌头]有时效性限制
    - 终端自行用[令牌头]和[令牌尾]合成[令牌]，在后续的RPC请求中始终附加[终端号]+[令牌]
    - 在[令牌头]失效前，终端负责申请新的[令牌头]并刷新令牌

    23. 数据报文签名校验
    VR的上下行报文都采用签名验证模式, dev-mode下可忽略:
    - 发送方对上行报文所有字段排序后抽取成KV字符串
    - 发送方使用椭圆曲线算法和令牌衍生密钥对KV字符串签名，将签名数据作为sig字段附在报文末尾
    - 接收方使用同样方式演算sig字段后进行比对校验

    24. 访问控制列表机制
    VR采用访问控制列表机制[ACL]控制终端远程访问能力, 超级终端号[xxxxxxxx-vallnet-root-xxxxxxxxxxxxxx]不受此限制

    25. 加密传输
    收发方对报文应用Chacha20或AES对称加解密方案，进一步提高安全性和隐私性, 此功能属于定制方案, 不包含在引擎通用版中

3. 交互调用

可以通过如下方式和百谷王链节点交互：
- 使用系统提供的SDK[gamerpc]和节点交互。目前仅支持js，可用于浏览器环境和Nodejs环境，支持短连/长连等模式，示例见单元测试文件
- 使用系统提供的行命令工具CLI和节点交互，例如：
```bash
# 获取帮助信息
vc help
# 查询系统概况
vc sys.info
```
- 使用 Http Post 和节点交互，可以借助工具软件如[Postman]执行相关测试

交互调用流程描述如下(开发模式[dev-mode=true]下可以跳过步骤a/b/c, 直接执行步骤d)：

a. 系统管理员通过行命令为终端生成并颁发证书

```bash
# 以终端号为输入参数执行命令，获取证书信息
vc sys.createAuthToken account
```

注：测试阶段，account name 可统一使用系统管理员默认账号 'xxxxxxxx-vallnet-root-xxxxxxxxxxxxxx'

[Response]
```json
[
    {
      "cid": "account name",
      "encry": "adakaeeoconigoelheknmmggajiogcldnjggadlahofjoiakmdldjeldjnfhmgmjhnlopoemodbmhiiccffhcmnhdigmnpfaolmfibfonjphbgkimcejcplemfpeobnnfghifgkhfehbbgeanefdpghghpkbkopn",
      "token": "03252fcf8061d221ad0a066d3e8447fd1e6184874a2fdc02eeced5c47d14bd8462"
    }
]
```

注: dev-mode 模式下直接返回[令牌尾]即token字段, 否则要通过解密得到明文，示例如下：
```js
const toolkit = require('gamerpc')
const connector = require('../test/util/connector');

//创建超级用户使用的连接器
const remoteSuper = connector();
//创建普通用户使用的连接器
const remoteOperator = connector();

let env = {account: '*****'};

//超级用户执行指令，为普通用户分配令牌
let ret = await remoteSuper.execute('sys.createAuthToken', [env.account]);

//解密得到令牌明文，分配给普通用户
let {aeskey, aesiv} = remoteSuper.getAes();
env.token = toolkit.decrypt(aeskey, aesiv, ret[0].encry);

//普通用户使用令牌信息设置连接器属性
remoteOperator.setup({
    type: 'testnet', 
    cid: env.account, 
    token: env.token
});
```

b. 终端向全节点申请[令牌头]

[Request]
```bash
POST http://localhost:2102

Headers:
    Authorization: Basic Yml0Y29pbnJwYzpib29rbWFuc29mdA==
    Content-Type: application/json

Body: 
    raw
    {
	    "method": "token.random",
	    "params": ["xxxxxxxx-vallnet-root-xxxxxxxxxxxxxx"]
    }
```

[Response]
```json
{
  "code": 0,
  "error": null,
  "result": "3045022100ab6224b43bb66ea01676bcfe525fc3b5f3a789f1b711a38750d228f14bb0077b02202212e02118cf2ace64061cbd53fd051404875ff965464bded02269d2008c7080"
}
```

c. 终端本地计算最终的访问令牌, 注意每次[令牌头]发生更新都需要重新计算

如下为计算最终令牌的js代码示例，其它语言可仿制其流程:
```js
const crypto = require('crypto');

// 终端获颁证书中的[令牌尾]
let token = '03252fcf8061d221ad0a066d3e8447fd1e6184874a2fdc02eeced5c47d14bd8462';
// token.random 的返回结果，即[令牌头]
let random = '3045022100ab6224b43bb66ea01676bcfe525fc3b5f3a789f1b711a38750d228f14bb0077b02202212e02118cf2ace64061cbd53fd051404875ff965464bded02269d2008c7080';
// 计算获得最终的令牌'e1624d5139cf1971ed05cb61be8a7889858ae141fe0d6a0e5414309917e2d971'
let calc = crypto.createHmac('sha256', random).update(token).digest().toString('hex');
```

可以使用行命令模拟计算:
```bash
vc hmac.calc account "token" "random"
```

```json
{ 
    "cid"   : "account name",
    "token" : "03aee0ed00c6ad4819641c7201f4f44289564ac4e816918828703eecf49e382d08",
    "random": "3045022100ab6224b43bb66ea01676bcfe525fc3b5f3a789f1b711a38750d228f14bb0077b02202212e02118cf2ace64061cbd53fd051404875ff965464bded02269d2008c7080",
    "calc"  : "e1624d5139cf1971ed05cb61be8a7889858ae141fe0d6a0e5414309917e2d971" 
}
```

d. 终端携带终端号和访问令牌，向全节点申请执行远程命令

```bash
POST http://localhost:2102

Headers:
    Authorization: Basic Yml0Y29pbnJwYzpib29rbWFuc29mdA==
    Content-Type: application/json

Body: 
    raw
    {
        # 命令字 - 查询当前链库概要信息
        "method":"block.tips",
        # 命令参数数组
        "params":[],
        # 钱包编号，默认 primary 
        "wid": "primary",
        # 终端号
        "cid": "account name",
        # (dev-mode模式下置空)访问令牌，就是第2步计算出来的 calc 字段值
        "token": "e1624d5139cf1971ed05cb61be8a7889858ae141fe0d6a0e5414309917e2d971",
        # 上行报文签名(dev-mode模式下可置空)
        "sig":""
    }
```

签名字段[sig]生成流程如下所述:
```js
/**
 * 1. stringify通过字段排序、抽取形成并返回KV字符串
 * 2. hash256计算并返回数据的连续两次标准SHA256运算后的哈希值
 * 3. secp256k1.sign是椭圆曲线签名算法
 */

let conf = {
    cid: '',        //终端编号
    token: '',      //终端令牌
    id: '',         //钱包名称
}

let msg = hash256(Buffer.from(stringify({
    method,
    params,
    cid: conf.cid,
    wid: conf.id,
})));

let sig = secp256k1.sign(msg, hash256(Buffer.from(conf.token))).toString('hex');
```

调用示例：
```json
//查询当前链库概要信息
{
    "method":"block.tips",
    "params":[],
}

//手工产生一个新的区块
{
    "method":"miner.generate.admin",
    "params":[1],
}
```

如果调用返回如下错误，很可能是 random 过时，此时需要重新从步骤2开始执行
```json
{
    "type": "HmacError",
    "message": "Hmac Auth failure."            
}
```

## 功能列表

- 指标测试-负载测试: 通过在被测系统上不断增加压力，直到性能指标，例如“响应时间”超过预定指标或者某种资源使用已经达到饱和状态时系统的处理极限。
- 指标测试-可靠性测试: 通过给系统加载一定的业务压力（例如资源在70%-90%的使用率）的情况下，让应用持续运行一段时间，测试系统在这种条件下是否能够稳定运行。
- 指标测试-性能测试: 对指定业务压力量和使用场景组合，测试系统的性能是否满足预定指标要求。
- 指标测试-压力测试: 测试系统在一定饱和状态下，例如CPU、内存等在饱和使用情况下，系统能够处理的会话能力，以及系统是否会出现错误。
- 账户管理
    创建账户：创建一个新账户，多用户系统下作为用户代理，单用户系统下作为功能性子账户
    查询账户：查询指定账户基础信息
    列表账户：列表当前钱包内所有账户
    查询账户余额：查询指定账户通证余额
    列表收款记录：查询指定账户收款明细
    查询收款总额：查询指定账户收款总额
    查询日志：查询指定账户变更日志
- 用户管理
    分配令牌：超级用户为普通用户映射账户并分配令牌
    添加成员：超级用户将指定用户加入指定角色的成员列表，添加前用户无法执行受限指令，添加后方可
    移除成员：超级用户将指定用户移出指定角色的成员列表，移除后用户无法执行受限指令
    初始化：在节点重启事件处理句柄中，从业务中台导入权限初始设定
    用户转账：超级用户为普通用户转账，转账后普通用户账户余额发生对应变化
- 锁仓机制
    绝对高度锁：构造绝对高度锁仓交易
    绝对时间锁：构造绝对时间锁仓交易
    相对高度锁：构造相对高度锁仓交易
    相对时间锁：构造相对时间锁仓交易
    解锁交易: 通过适当提升块链高度来解锁交易
- 钱包管理
    创建钱包：在钱包管理器中创建一个新钱包
    列表钱包：列表钱包管理器中的所有钱包
    查询钱包：查询钱包概要说明
    密钥备份：用助记词模式导出钱包密钥作为备份
    导出备份：从钱包管理器中导出钱包备份
    导入备份：将钱包备份导入钱包管理器
- 凭证管理
    一级市场发行：厂商发行商业凭证
    一级市场购买：用户在市场购买厂商发行的商业凭证
    无偿转让：用户间无偿转让商业凭证
    二级市场拍卖：用户在二级市场售卖持有的商业凭证
    二级市场购买：用户在二级市场购买他人售卖的商业凭证
    商业支付：用户通过商业支付接口购买厂商服务，合约分润至导流媒体和商业凭据持有者名下
    查询媒体分润：查询商业支付中导流媒体获取分润
    查询凭证分润：查看商业支付中商业票据持有者获取分润
    一级市场扩发：厂商扩充发行商业凭证
- 跨链机制
    发起请求：发起一笔跨链交易请求
    取消请求：发起方取消先前发起的跨链交易请求
    响应请求：对手方响应跨链交易请求
    取消响应：对手方取消对跨链交易请求的响应
    兑现请求：发起方兑现先前发起的请求，同时开放密钥
    兑现响应：对手方兑现先前做出的响应，前提是获取了开放密钥
    合约查询：查询历史跨链交易合约记录
- 节点证书
    验证证书：验证用户是否持有合法证书，决定其是否拥有记账权
    查询证书：查询用户名下证书
    转让证书：将证书转让他人
- 节点选举
    验证选举：通过执行记账流程，验证节点是否已通过投票获取记账权
    投票选举：用户就记账权进行投票
    查询选举：查询指定节点是否拥有记账权
- 节点管理
    节点运行：调度子进程运行节点
    自动记账：设置节点自动记账
    手动记账：设置手动记账
    查询记账设置：查询记账设置的当前状态
    查询记账难度：查询当前记账难度
    查询区块信息：查询指定区块信息
    查询区块数据：获取区块原始信息
    查询区块概要：获取区块概要信息
    查询区块列表：获取近期区块列表
    查询同步：获取节点同步状态
    查询系统概要：获取系统概要信息
    查询分叉：列表所有分叉的头部信息
    重置区块：重置区块头至指定区块
    查询块链顶部：获取当前主链顶部区块哈希
    查询块链高度：获取当前主链区块数量
    网络状态：查询网络概要信息
    节点状态：查询对等节点概要信息
    矿机状态：查询矿机概要信息
    通证状态：查询通证概要信息
    查询连接：查询当前连接数
    查询块链顶部：获取当前主链顶部区块哈希
    查询块链高度：获取当前主链区块数量
- 交易管理
    发送交易：发送交易至指定地址
    按哈希查询交易：查询指定哈希对应的交易记录
    按地址查询交易：查询指定地址下的交易列表
    查询历史交易：查询历史交易列表
- 机构管理
    创建机构：机构登记创建链上映射对象
    查询机构：根据机构编号查询机构信息
    修改机构：修改机构已登记信息
- 多签合约
    创建多签钱包：用户为多签合约设立专用钱包
    创建多签合约：发起方建立一个多签合约实例
    共建多签合约：除发起方外的参与方分别上传自己的公钥，完成合约共建
    主动运行多签合约：参与方之一主动运行多签合约
    辅助运行多签合约：除运行方外的参与方分别查询多签交易列表，动用多签钱包补签合约
- 电子签章
    个人签发：个人用户签发证书
    查询证书：根据证书编号查询证书内容
    查询列表：查询证书列表
    验证证书：验证证书的有效性
    废止证书：个人用户废止先前签发的证书
    查询废止：查询电子证书废止列表
    验证证书：验证证书的有效性
    机构签发：机构为个人用户签发证书
    机构增信：机构为其他机构增信
    查询信用：查询机构信用等级
    签署电子合同：个人用户间签署电子合同
    验证电子合同：第三方检索验证已签署电子合同
- 地址管理
    创建地址：创建一个新地址
    查询余额：获取指定地址金额汇总信息
    查询账户地址：列表指定账户下收款地址
    查询概要：获取指定地址的汇总信息
    查询进项：根据地址查询进项
    查询进项总额：根据地址查询进项总额
    查询归属账户：查询指定地址对应的账户
    查询订单：查询从订单中获取符合条件的地址集合
    查询历史：获取指定地址相关历史信息
    查询通证：获取指定地址UTXO集合
    查询交易：获取指定地址相关的交易列表
- 道具管理
    机构注册：发行道具厂商进行机构注册
    创建道具：机构创建一个道具，并成为其初始拥有者
    转移道具：道具拥有者转移一个道具
    拍卖道具：道具拥有者拍卖道具
    竞拍道具：第三方参与竞拍道具
    熔铸道具：道具拥有者熔铸一个道具，释放相关通证
- 安全通信
    建立安全信道
    发送安全消息

## 单元测试

2. 安装说明

- 确保目标主机硬件就绪，并处于联网状态(示例地址 114.116.122.195)
- 安装操作系统 Windows Server 2019
- 安装运行环境 Nodejs@12.20.3, 该运行环境自带依赖包管理器 npm@6.14.4
- 安装项目库
在目标主机上建立专门的管理目录，行命令模式下，进入管理目录，执行如下命令：
```bash
# 克隆项目代码库
git clone https://github.com/bookmansoft/gamegoldnode
# 进入项目目录
cd gamegoldnode
# 上述命令执行结束后，当前目录为项目根目录 ./gamegoldnode
```
- 配置依赖项
在行命令模式下，确保处于项目根目录下，执行如下命令：
```bash
# 安装依赖项
npm i
# 生成快捷指令链接
npm link
# 安装测试套件mocha
npm i mocha@5.2.0 -g
```
- 启动节点
行命令模式下，确保处于项目根目录下，执行如下命令：
```bash
npm start
```

采用直接登录目标主机、通过控制台命令窗口执行各项行命令的方式，执行全部测试流程。使用Mocha测试套件和事先撰写的单元测试文件来实现预定的测试流程。具体操作描述如下：

- 打开一个行命令窗口，确保进入项目根目录，然后执行如下命令运行全节点

```bash
# 运行前确保没有相同配置的全节点处于运行状态，否则会因为文件锁和端口冲突而无法正常运行
npm start
# 注：如需退出先前运行的全节点进程，可在相关控制台窗口中连续输入两次 Ctrl+C 组合键
```

- 打开另外一个行命令窗口，确保进入项目根目录，然后执行如下命令执行单元测试

```bash
# 如果尚未安装mocha工具，可执行如下命令安装
npm i mocha@5.2.0 -g
## 运行指定单元测试
mocha test/地址管理
# 运行全部单元测试
mocha
```
