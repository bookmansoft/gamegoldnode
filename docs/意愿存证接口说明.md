# 意愿存证接口说明

## 业务流程描述

1. 首节点启动，然后联盟节点依次启动，通过合理配置，和首节点及其它联盟节点组成对等网络。
2. 顶层服务提供商可以实现一个网管系统，调度管理全部节点
3. 特定服务提供商的业务中台得到特定节点授权后，以 HTTP POST 模式调用特定节点接口。授权连接过程详见《使用手册》
4. 特定服务提供商通过[注册企业证书]接口，为其企业客户注册[企业数字证书]
5. 特定服务提供商通过[注册用户证书]接口，为其企业客户的用户注册[用户数字证书]
6. 企业客户向特定服务提供商提交用户意愿资料，服务提供商计算用户意愿资料对应哈希后，通过[提交意愿存证]接口，使用[用户数字证书]签名并上链意愿存证，返回意愿存证编号
7. 特定审核方得到特定节点授权，以 HTTP POST 模式调用[验证意愿存证]接口，验证由存证编号指定的意愿存证的合法性

## 主要接口描述

注：使用 Postman 模拟操作时，目标地址默认为 http://127.0.0.1:2102
注：使用Mocha进行单元测试时，执行如下指令:
```bash
# 安装Mocha(如果尚未安装)
npm i mocha -g
# 运行单元测试
mocha test/意愿存证
```

### 注册企业证书

Post Input

```json
{
  "method": "cp.create",    //命令字：注册企业证书
  "wid": "primary",         //钱包编号，默认"primary"
  "params": [
    "bookmansoft",          //企业名称
    "127.0.0.1"             //企业公网IP地址
  ]
}
```

Post Output

```json
{
    "code": 0,                    //返回码，零表示正常
    "error": null,                //错误信息，NULL表示正常
    "result": {
        "name": "bookmansoft",    //企业名称
        "ip": "127.0.0.1",        //公网IP
        "cid": "a3c92fe0-2809-11eb-bf66-616895c53e56",                                  //企业证书编号
        "pubAddress": "tb1qzk0r4w334y0ty4fdaymasm74ej38stxanpav5q",                     //证书注册地址
        "pubKey": "02385b9f0e2f659ec3ea9dd30539cae4ca47bf118384ab207761c81d2294465b86", //注册地址对应公钥
        "txid": "bf1cc405565e369c481eedce929ebf34c79dddcb10c126bce54ac67211eebbea",     //所在交易编号
    },
    "sig": "*"                    //报文签名
}
```

### 查询企业证书

**注意：查询前注册必须得到确认，手动记账模式下，需要先执行 miner.generate.admin 1 再查询**

Post Input

```json
{
  "method": "cp.byName",    //命令字：查询企业证书
  "wid": "primary",         //钱包编号，默认"primary"
  "params": [
    "bookmansoft"           //企业名称
  ]
}
```

Post Output

```json
{
    "code": 0,
    "error": null,
    "result": {
        "cid": "86cefc90-280d-11eb-ad4e-a1d30db67998",                                  //企业证书编号
        "name": "bookmansoft",                                                          //企业名称
        "ip": "127.0.0.1",                                                              //公网IP
        "pubAddress": "tb1q0lh9d8drhf4rzgm5n9zg0ls4yew5n6l229uxeh",                     //证书注册地址
        "pubKey": "027136a848b247f3976cc36c988dacabaaf5c3832a61e70f02e3e9f116a0a80a54", //注册地址对应公钥
        "height": 101,                                                                  //所在区块高度
    },
    "sig": "*"                                                                          //报文签名
}
```

### 注册用户证书

Post Input

```json
{
  "method": "cp.user",      //命令字：注册用户证书
  "wid": "primary",         //钱包编号，默认"primary"
  "params": [
    "cp.id",                //企业证书编号 
    "alice.name",           //用户编码 
    null,                   //保留字段
    "cp.id",                //归属账号
  ]
}
```

Post Output

```json
{
    "code": 0,                    //返回码，零表示正常
    "error": null,                //错误信息，NULL表示正常
    "result": {
        "data": {
            "cid": "86cefc90-280d-11eb-ad4e-a1d30db67998",                                  //企业证书编号
            "uid": "u0001",                                                                 //用户编号
            "time": 5351784,                                                                //时间戳
            "addr": "tb1ql7kr2j29ljulja65qufscxu92fw7qgpp2trn4e",                           //证书地址
            "pubkey": "0220a47590fdf8e4e2ef025afe867a4e50037adbd77edbb319c3092acef1219afc"  //证书公钥
        },
        "sig":"*"                 //证书私钥签名字段
    },
    "sig": "*"                    //报文签名
}
```
**经注册的用户证书中，证书地址代表用户，作为后续操作中的见证地址，证书私钥签名字段和证书公钥作为签名验证手段**

### 提交意愿存证

Post Input

```json
{
  "method": "ca.issue",     //命令字：提交意愿存证
  "wid": "primary",         //钱包编号，默认"primary"
  "params": [
    "bob.address",          //证书见证地址
    "",                     //证书名称
    "cp.pubkey",            //证书发放地址公钥
    "content",              //内容哈希
    0,                      //相对有效期，零表示一个统计周期(正常模式下2016个块，加速模式下14个块)
    "cp.id",                //见证地址归属账号
  ]
}
```

Post Output

```json
{
    "code": 0,
    "error": null,
    "result": {
      "erid": "9dbe0640-2816-11eb-97ad-2718bf928be4",                                     //存证编号
      "witness": "020b5d09ba10c1f05ecfbc9e54eaa3f94c1e974825f3fe77ad345ed6d119d50fb0",    //见证者公钥哈希
      "validHeight": 118,                                                                 //有效高度
      "signature": "*",                                                                   //存证签名字段
      "source": {
        "subjectName": "9dbe0640-2816-11eb-97ad-2718bf928be4",                            //存证名称或编号
        "pubkey": "02d83c4d1dff5b1b3440c44138bede0f31a3257021cdbff390e147154f2f1ae28f",   //目标地址公钥
        "subjectHash": "bc62d4b80d9e36da29c16c5d4d9f11731f36052c72401a76c23c0fb5a9b74423" //内容哈希
      },
    },
    "sig": "*"                                                                            //报文签名
}
```

### 验证意愿存证

Post Input

```json
{
  "method": "ca.verify",    //命令字：验证意愿存证
  "wid": "primary",         //钱包编号，默认"primary"
  "params": [
    "erid"                  //意愿存证编号
  ]
}
```

Post Output

```json
{
    "code": 0,
    "error": null,
    "result": {
      "verify": true,           //校验结果 true 真 false 伪
      "validHeight": 130,       //有效高度
      "curHeight": 117,         //当前高度，这意味着有效期为 130 - 117 = 13
      "source": {
        "subjectName": "beed7010-2818-11eb-97ad-2718bf928be4",                              //存证名称或编号
        "pubkey": "037c9989c9cb1090d1561c797404c822636e7ee54a779f9175a6b8c542b110d497",     //目标地址公钥
        "subjectHash": "bc62d4b80d9e36da29c16c5d4d9f11731f36052c72401a76c23c0fb5a9b74423"   //内容哈希
      }
    },
    "sig": "*"                                                                              //报文签名
}
```

### 手动记账

可以使用特定指令开启自动记账，但调测阶段建议使用手动记账。
由于通证激活需要一定高度，故系统运行之初，要先手工记账100。在企业注册调用后，也需手工记账1，以使得该注册得到确认，此后方可查询

Post Input

```json
{
  "method": "miner.generate.admin", //命令字：手动记账
  "wid": "primary",                 //钱包编号，默认"primary"
  "params": [
    100,                            //记账数量
  ]
}
```

Post Output

```json
{
    "code": 0,                      //返回码，零表示执行成功
    "error": null,                  //错误信息，NULL表示执行成功
    "result": [
        "*",                        //新区块的哈希值
    ],
    "sig": "*"                      //报文签名
}
```

## 单元测试

详见 test/意愿存证.js