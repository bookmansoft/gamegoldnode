# 意愿存证接口说明

## 业务流程描述

1. 盟主节点启动，然后联盟节点依次启动，通过合理配置，和盟主节点及其它联盟节点组成对等网络。
2. 顶层服务提供商可以实现一个网管系统，调度管理全部节点
3. 特定服务提供商运行自己的节点，并使用业务中台和该节点授权连接后，用Post方式调用节点接口。授权连接过程详见《使用手册》
4. 特定服务提供商通过[注册企业证书]接口，为其企业客户注册[企业证书]. 企业证书编号将作为该企业的节点账户
5. 特定服务提供商通过[注册用户证书]接口，为其企业客户的用户注册[用户证书]，这些用户证书统一存储于该企业的节点账户下，每个证书包括私钥和公钥两部分
6. 企业客户向特定服务提供商提交用户意愿资料，服务提供商计算用户意愿资料对应哈希后，通过[提交意愿存证]接口，使用[用户证书]私钥部分签名意愿存证，广播上链后返回意愿存证编号
7. 特定审核方得到特定节点授权，用POST方式调用[验证意愿存证]接口，以存证编号为传入参数，根据返回值判断相应意愿存证的合法性

## 接口描述

注：使用 Postman 模拟操作时，目标地址默认为 http://127.0.0.1:2102

### 注册企业证书

Post Input

```json
{
  "method": "cp.create",    //命令字：注册企业证书
  "wid": "primary",         //钱包编号，固定为"primary"
  "params": [
    "bookmansoft",          //企业名称，可自由拟定，长度在4~50字节之间
    "127.0.0.1"             //企业公网IP地址，用于某些回调场景中
  ]
}
```

Post Output

```json
{
    "code": 0,                    //返回码，零表示正常
    "error": null,                //错误信息，NULL表示正常
    "result": {
        "name": "bookmansoft",    //企业名称，和提交请求中企业名称字段保持一致
        "ip": "127.0.0.1",        //公网IP，和提交请求中企业公网IP地址保持一致
        "cid": "a3c92fe0-2809-11eb-bf66-616895c53e56",                                  //企业证书编号，企业唯一标识
        "pubAddress": "tb1qzk0r4w334y0ty4fdaymasm74ej38stxanpav5q",                     //证书注册地址
        "prvKey": "02385b9f0e2f659ec3ea9dd30539cae4ca47bf118384ab207761c81d2294465b86", //注册地址对应私钥
        "pubKey": "02385b9f0e2f659ec3ea9dd30539cae4ca47bf118384ab207761c81d2294465b86", //注册地址对应公钥
        "txid": "bf1cc405565e369c481eedce929ebf34c79dddcb10c126bce54ac67211eebbea",     //所在交易编号
    },
    "sig": "*"                    //报文签名
}
```

### 查询企业证书

**注意：查询前注册必须得到确认，手动记账模式下，需要先执行 miner.generate.admin 1 再查询**

Post Input

```json
{
  "method": "cp.byName",    //命令字：查询企业证书
  "wid": "primary",         //钱包编号，固定"primary"
  "params": [
    "bookmansoft"           //企业名称，必须是先前已经注册成功的企业名称
  ]
}
```

Post Output

```json
{
    "code": 0,
    "error": null,
    "result": {
        "cid": "86cefc90-280d-11eb-ad4e-a1d30db67998",                                  //企业证书编号
        "name": "bookmansoft",                                                          //企业名称
        "ip": "127.0.0.1",                                                              //公网IP
        "pubAddress": "tb1q0lh9d8drhf4rzgm5n9zg0ls4yew5n6l229uxeh",                     //证书注册地址
        "pubKey": "027136a848b247f3976cc36c988dacabaaf5c3832a61e70f02e3e9f116a0a80a54", //注册地址对应公钥
        "height": 101,                                                                  //所在区块高度，表示已上链
    },
    "sig": "*"                                                                          //报文签名
}
```

返回信息中最重要的是[cid], 企业证书编号，是企业在链态上的全局唯一编号

### 注册用户证书

Post Input

```json
{
  "method": "cp.user",      //命令字：注册用户证书
  "wid": "primary",         //钱包编号，固定"primary"
  "params": [
    "cid",                  //企业证书编号, 同 cp.create 命令返回中的 cid 字段
    "userName",             //用户编号, 用户在企业内部的编码信息，字符串格式
    null,                   //保留字段
    "cid",                  //归属账号，此处仍旧填写企业证书编号，表示以此为分类标识，统一存储用户证书
  ]
}
```

Post Output

```json
{
    "code": 0,                    //返回码，零表示正常
    "error": null,                //错误信息，NULL表示正常
    "result": {
        "data": {
            "cid": "86cefc90-280d-11eb-ad4e-a1d30db67998",                                  //企业证书编号
            "uid": "u0001",                                                                 //用户编号
            "time": 5351784,                                                                //时间戳
            "addr": "tb1ql7kr2j29ljulja65qufscxu92fw7qgpp2trn4e",                           //证书地址，用户唯一标识
            "pubkey": "0220a47590fdf8e4e2ef025afe867a4e50037adbd77edbb319c3092acef1219afc"  //证书公钥
        },
        "sig":"*"                 //证书私钥签名字段
    },
    "sig": "*"                    //报文签名
}
```
**经注册的用户证书中，证书地址代表用户，作为后续操作中的见证地址，证书公钥作为验证手段**
**用户证书私钥并未随调用返回，将在必要时由系统代为调用**

### 提交意愿存证

Post Input

```json
{
  "method": "ca.issue",     //命令字：提交意愿存证
  "wid": "primary",         //钱包编号，固定"primary"
  "params": [
    "witness.address",      //代表见证人的用户证书地址
    "",                     //存证名称
    "address.pubkey",       //存证存储地址的公钥
    "content",              //存证内容哈希
    0,                      //存证相对有效期，零表示一个统计周期(正常模式下2016个块，加速模式下14个块)
    "cid",                  //用户证书地址归属账号，也就是用户归属企业的企业证书编号
  ]
}
```

Post Output

```json
{
    "code": 0,
    "error": null,
    "result": {
      "erid": "9dbe0640-2816-11eb-97ad-2718bf928be4",                                     //存证编号
      "witness": "020b5d09ba10c1f05ecfbc9e54eaa3f94c1e974825f3fe77ad345ed6d119d50fb0",    //见证人公钥哈希
      "validHeight": 118,                                                                 //有效高度
      "signature": "*",                                                                   //存证签名字段
      "source": {
        "subjectName": "9dbe0640-2816-11eb-97ad-2718bf928be4",                            //存证名称或编号
        "pubkey": "02d83c4d1dff5b1b3440c44138bede0f31a3257021cdbff390e147154f2f1ae28f",   //存证存储地址公钥
        "subjectHash": "bc62d4b80d9e36da29c16c5d4d9f11731f36052c72401a76c23c0fb5a9b74423" //存证内容哈希
      },
    },
    "sig": "*"                                                                            //报文签名
}
```

上述返回值中，最重要的是[erid]，即存证编号

### 查询意愿存证

Post Input

```json
{
  "method": "ca.byName",            //命令字：通过企业证书编号和用户编号查询意愿存证(合并记录，给出最终状态)
  "wid": "primary",                 //钱包编号，固定"primary"
  "params": [
    "cid",                          //企业证书编号
    "userName",                     //用户编号
  ]
}
```

Post Output

```json
{
    "code": 0,                      //返回码，零表示执行成功
    "error": null,                  //错误信息，NULL表示执行成功
    "result": {
      "list": [                     //包含多条证书数据的数组
        {
          "oper": "erIssue",
          "erid": "c4d1f8f0-29fa-11eb-b1c7-892b1bbb99a7",
          "witness": "037b5be071e610a59498234ad095acd78da4b5fc621a3b42f7dd54c65b15bde3fe",
          "validHeight": 359,
          "signature": "*",
          "source": {
            "subjectName": "c4d1f8f0-29fa-11eb-b1c7-892b1bbb99a7",
            "pubkey": "037b5be071e610a59498234ad095acd78da4b5fc621a3b42f7dd54c65b15bde3fe",
            "subjectHash": "bc62d4b80d9e36da29c16c5d4d9f11731f36052c72401a76c23c0fb5a9b74423"
          },
          "ver": {
            "verify": true,         //证书有效性标记
            "validHeight": 359,     //有效高度
            "curHeight": 346,       //链态当前高度
          }
        }
      ],
      "page": 0,                    //页码
      "count": 10,                  //页数
    }
    "sig": "*"
}
```

### 查询意愿存证日志

Post Input

```json
{
  "method": "ca.log",               //命令字：通过企业证书编号和用户编号查询意愿存证的日志(不合并记录，给出全部相关流水记录)
  "wid": "primary",                 //钱包编号，固定"primary"
  "params": [
    "cid",                          //企业证书编号
    "userName",                     //用户编号
  ]
}
```

Post Output

```json
{
    "code": 0,                      //返回码，零表示执行成功
    "error": null,                  //错误信息，NULL表示执行成功
    "result": {
      "list": [                     //包含多条证书数据的数组
        {
          "oper": "erIssue",
          "erid": "c4d1f8f0-29fa-11eb-b1c7-892b1bbb99a7",
          "witness": "037b5be071e610a59498234ad095acd78da4b5fc621a3b42f7dd54c65b15bde3fe",
          "validHeight": 359,
          "signature": "*",
          "source": {
            "subjectName": "c4d1f8f0-29fa-11eb-b1c7-892b1bbb99a7",
            "pubkey": "037b5be071e610a59498234ad095acd78da4b5fc621a3b42f7dd54c65b15bde3fe",
            "subjectHash": "bc62d4b80d9e36da29c16c5d4d9f11731f36052c72401a76c23c0fb5a9b74423"
          }
        }
      ],
      "page": 0,                    //页码
      "count": 10,                  //页数
    }
    "sig": "*"
}
```

### 验证意愿存证

Post Input

```json
{
  "method": "ca.verify",    //命令字：验证意愿存证
  "wid": "primary",         //钱包编号，固定"primary"
  "params": [
    "erid"                  //存证编号，必须是已经生成的有效存证编号
  ]
}
```

Post Output

```json
{
    "code": 0,
    "error": null,
    "result": {
      "verify": true,           //校验结果 true 真 false 假
      "validHeight": 130,       //存证有效高度
      "curHeight": 117,         //链态当前高度，这意味着有效期为 130 - 117 = 13
      "source": {
        "subjectName": "beed7010-2818-11eb-97ad-2718bf928be4",                              //存证名称或编号
        "pubkey": "037c9989c9cb1090d1561c797404c822636e7ee54a779f9175a6b8c542b110d497",     //存证存储地址公钥
        "subjectHash": "bc62d4b80d9e36da29c16c5d4d9f11731f36052c72401a76c23c0fb5a9b74423"   //存证内容哈希
      }
    },
    "sig": "*"                                                                              //报文签名
}
```

### 作废意愿存证

Post Input

```json
{
  "method": "ca.abolish",   //命令字：提交意愿存证
  "wid": "primary",         //钱包编号，固定"primary"
  "params": [
    "witness.address",      //代表见证人的用户证书地址
    "erid",                 //已生成的存证编号
    0,                      //废止决定生效高度
    "cid",                  //用户证书地址归属账号，也就是用户归属企业的企业证书编号
  ]
}
```

Post Output

```json
{
    "code": 0,
    "error": null,
    "result": {
        "oper": "erAbolish",
        "erid": "d6337750-2b2a-11eb-aa42-9ba174cba562", //作废的证书编号
        "witness": "*",                                 //见证人公钥哈希
        "abolishHeight": 0,                             //作废的相对区块高度
        "signature": "*"                                //存证签名字段
    },
    "sig": "*"                                          //报文签名
}
```

### 转账 tx.send

该指令利用地址字符串指定接收单位，向其转账指定金额的通证

Post Input

```json
{
  "method": "tx.send",              //命令字：转账
  "wid": "primary",                 //钱包编号，固定"primary"
  "params": [
    "address",                      //转账目标地址
    "amount",                       //转账金额
    "account",                      //转账发起账号
  ]
}
```

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {
    "hash": "42e16606246c9ec0df71694aa1f988f44d5cc7c61d19a97d6e9bc8614abfab4b",
    "date": "2020-11-17T15:39:53Z",
    "inputs": [],
    "outputs": [
      {
        "value": 100000000,                                       //转账金额
        "address": "tb1qx98glvphcj5muzyvadphzal7sw5xfljljd44yn",  //转账目标地址
      }
    ],
    "tx": "*"
  },
  "sig": "*"
}
```

### 转账 tx.create

该指令利用账号指定接收单位，向其转账指定金额的通证，通证将被发送到归属指定账号的某个地址上

Post Input

```json
{
  "method": "tx.create", //命令字：创建一笔交易
  "wid": "primary",                 //钱包编号，固定"primary"
  "params": [
    {"sendnow": true /*指示该交易创建后必须立即发送*/}, 
    [
        {
            "value": 100000000,     //通证数值
            "account": "account",   //目标账户，注意不是用地址指定接收单位
        },
    ]
  ]
}
```

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {
    "hash": "42e16606246c9ec0df71694aa1f988f44d5cc7c61d19a97d6e9bc8614abfab4b",
    "date": "2020-11-17T15:39:53Z",
    "inputs": [],
    "outputs": [
      {
        "value": 100000000,         //转账金额
        "address": "*",             //转账目标地址
      }
    ],
    "tx": "*"
  },
  "sig": "*"
}
```

### 手动记账

可以使用特定指令开启自动记账，但调测阶段建议使用手动记账。
由于通证激活需要一定高度，故系统运行之初，要先手工记账100。在企业注册调用后，也需手工记账1，以使得该注册得到确认，此后方可查询

Post Input

```json
{
  "method": "miner.generate.admin", //命令字：手动记账
  "wid": "primary",                 //钱包编号，固定"primary"
  "params": [
    100,                            //记账数量
  ]
}
```

Post Output

```json
{
    "code": 0,                      //返回码，零表示执行成功
    "error": null,                  //错误信息，NULL表示执行成功
    "result": [
        "*",                        //新区块的哈希值
    ],
    "sig": "*"                      //报文签名
}
```

### 查询账户余额

Post Input

```json
{
    "method": "balance.all",        //命令字：查询账户余额
    "params": ["cid"]               //账户名称，本场景下使用企业证书编号
}
```

Post Output

```json
    "code": 0,                      
    "error": null,                  
    "result":{
        "wid": 1,
        "id": "primary",
        "account": 663665735,       //账户内部索引编号
        "unconfirmed": 500000000,   //余额数值，但未完全确认(可能有部分数据尚未上链)
        "confirmed": 0,             //余额数值，相关数据已全部上链
        "locked": 0,                //冻结额度(锁仓)
    },
    "sig": "*"                      
```

### 设置矿机模式

Post Input

```json
{
    "method":"miner.set.admin",   //命令字：设置矿机模式
    "wid": "primary",           
    "params":[
      true,                       //指定何种模式 true 自动记账 false 手动记账
    ]
}
```

Post Output

```json
    "code": 0,                    
    "error": null,                
    "result": true,               //矿机当前运行模式
    "sig": "*"                    
```

### 查询矿机模式

Post Input

```json
{
    "method":"miner.check",       //命令字：设置矿机模式
    "wid": "primary",           
    "params":[
    ]
}
```

Post Output

```json
    "code": 0,                    
    "error": null,                
    "result": true,               //矿机当前运行模式
    "sig": "*"                    
```

## 单元测试

详见 test/意愿存证.js

注：使用Mocha进行单元测试时，执行如下指令:

```bash
# 安装Mocha(如果尚未安装)
npm i mocha@5.2.0 -g
# 运行单元测试
mocha test/意愿存证
```

## FAQ

Q: cp.create调用中，params的传参顺序是否是固定第一个是企业名称，第二个是企业IP
A: 目前是的，如有必要可以进行扩展或调整

Q: params参数是否可以调整为json格式，不建议使用数组的固定位置
A: params必须固定是数组，大多数调用也严格规范了参数顺序和个数，但每个参数都可以是JSON对象，例如
```json
{
        "method":"something",
        "wid": "primary",
        "params":[
            {"name":"bookman"}
        ]
}
```

Q: 转账 tx.send、转账 tx.create和手动记账这三个接口是什么作用？
A: tx.send tx.create 都是通证转账指令，前者是后者的快捷方式，只支持针对特定地址单笔转账，后者拥有更加丰富的参数。
手动记账是在矿机工作于手工模式时，通过主动调用该指令发起记账。自动记账模式下无需调用该接口，系统按照内在规律定期记账
矿机模式切换指令见[设置矿机模式]

Q: 存证相对有效期里什么是正常模式？什么是加速模式？一个周期是多久？
A: 正常模式以2016个区块高度为一个周期，加速模式以14个区块高度为一个周期。周期类似于心跳作用，用于控制多个周期性变量，例如，记账难度每一个周期进行一次动态调整。如果发布存证时相对高度填0，则表示存证从当前高度开始，在下一个周期范围内有效。

Q: source.subjectName的存证编号和erid存证编号是否是一样的？看样例的参数内容是一致的
A: 在调用 ca.issue 指令时，如果填写了存证名称，source.subjectName就是该存证名称；如果置空，source.subjectName用erid填充

Q: source.pubkey是否跟入参的address.pubkey是一样的？
A: 是的

Q: source.subjectHash是否跟入参的content是一样的？
A: 是的

Q: address.pubkey存证存储地址的公钥是否为上面的用户注册证书的data.pubkey参数数据？
A: 不一定。address.pubkey是存证存储地址对应的公钥，也是存证检索的索引值。如果希望以用户证书公钥作为存证索引，就需要在生成存证时，将存证发布到用户证书地址，此时两者是一致的。如果希望使用其它索引值，则两者就不一致。

Q: witness.address 是否为上面的用户注册证书的 data.addr 参数数据？
A: 是的。witness.address是见证人地址，也就是签发存证者的用户证书地址，联盟节点自动调度该地址对应的私钥签名存证后广播上链

Q: witness.address 是否为上面的用户注册证书的 data.addr 参数数据？
A: 是的。witness.address是见证人地址，也就是签发存证者的用户证书地址，联盟节点自动调度该地址对应的私钥签名存证后广播上链

Q: 企业证书也需要上链吗？为啥会有区块高度？
A: 是的，企业证书需要上链，所有有区块高度

Q: 企业证书的私钥存储在哪？
A: 企业证书注册时，如果没有指定注册地址，则由联盟节点自动分配一个地址，该地址对应的私钥就是企业证书的私钥，由联盟节点管理，保存在联盟节点的钱包系统中。

Q: 用户证书私钥和用户证书公钥是否都可以通过企业证书和用户编号进行计算得出？如果不行需要将私钥数据返回。
A: 企业证书是由联盟节点管理的，联盟节点会使用企业证书编号开设一个专有账户，在该专有账户下，利用用户编号衍生出用户证书，包含私钥公钥对。只需要指导企业证书编号和用户编号，联盟节点就可以计算出一致的用户证书。

Q: 使用手机号验证意愿结果的接口是哪个？
A: 使用[查询意愿存证]接口，直接使用用户手机号码作为用户编号(userName)

Q: 返回码有哪些状态？枚举的对照表缺少
A: 参见《系统调用返回值.md》
