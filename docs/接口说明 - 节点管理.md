# 节点管理接口说明

## 业务流程描述

1. 盟主节点运行 sys.aliance.create 为各个联盟节点创建根私钥，生成对应联盟根私钥文件并进行分发
2. 联盟节点正确导入联盟根私钥文件。盟主节点掌握所有联盟节点根私钥
3. 盟主节点运行 sys.aliance.gettoken 生成自身信道密钥，运行 sys.aliance.settoken 设置信道密钥
4. 盟主节点运行 sys.aliance.gettoken 生成各联盟节点的信道密钥，列表密钥和节点主机地址
5. 联盟节点运行 sys.aliance.gettoken 生成自身信道密钥，由于生成规则一致，因此该密钥与盟主节点异步生成密钥完全一致
6. 联盟节点运行 sys.aliance.settoken 设置信道密钥
7. 联盟节点按照盟主节点给出的信道列表，调用 sys.aliance.addpeer 指令添加可信信道。彼此信任的节点间可以展开端到端加密通信(类似VPN中的隧道协议)
8. 联盟节点运行 miner.setaddr.admin 设置记账奖励地址，同时也是选举人地址
9. 联盟节点运行 vote.send, 利用自身通证为指定选举人地址投票，票选出记账节点
10. 联盟节点运行 vote.check, 查看自身是否被选为记账节点
11. 联盟节点运行 'miner.set.admin true' 设置为自动记账，持续生成新的区块

## 接口描述

注：使用 Postman 模拟操作时，目标地址默认为 http://127.0.0.1:2102

### 选举节点

**选举结果需要经过一个周期后才能生效**

Post Input

```json
{
  "method": "vote.send",    //命令字：选举节点
  "wid": "primary",         //钱包编号，固定为"primary"
  "params": [
    "node.address",         //联盟节点官方地址
    100000000,              //投票动用的通证金额
  ]
}
```

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {
    "hash": "fa73e77e685551912f68e5afc2f4afae3638640b9bf004c63756f908b5ea51f4",
    "height": -1,
    "block": null,
    "date": "2020-11-19T16:02:02Z",
    "confirmations": 0,
    "tx": "*"
  },
  "sig": "*"
}
```

### 选举验证

Post Input

```json
{
  "method": "vote.check",   //命令字：选举验证
  "wid": "primary",         //钱包编号，固定为"primary"
  "params": [
    "node.address",         //待验证的联盟节点票选地址(同时也是其记账奖励地址)
  ]
}
```

Post Output

```json
```

## 单元测试

详见 test/节点选举.js

注：使用Mocha进行单元测试时，执行如下指令:

```bash
# 安装Mocha(如果尚未安装)
npm i mocha@5.2.0 -g
# 运行单元测试
mocha test/节点选举
```

## FAQ
