# 节点管理接口说明

## 业务流程描述

1. 盟主节点运行[创建联盟根私钥]为各个联盟创建根私钥，生成对应联盟根私钥文件并进行分发
2. 联盟节点正确导入联盟根私钥文件。盟主节点掌握所有联盟根私钥
3. 盟主节点运行[生成信道密钥]生成自身信道密钥，运行[设置信道密钥]设置信道密钥
4. 盟主节点运行[生成信道密钥]生成各联盟节点的信道密钥，列表密钥和节点主机地址
5. 联盟节点运行[生成信道密钥]生成自身信道密钥，由于生成规则一致，因此该密钥与盟主节点异步生成密钥完全一致
6. 联盟节点运行[设置信道密钥]设置信道密钥
7. 联盟节点按照盟主节点给出的信道列表，调用[添加可信信道]添加可信信道。彼此信任的节点间可以展开端到端加密通信
8. 联盟节点运行[查看选举地址]查看记账奖励地址，公布为自身的选举地址
9. 联盟节点运行[选举节点]，利用自身通证为指定选举地址投票，票选出记账节点
10. 联盟节点运行[验证节点]，查看自身是否被选为记账节点
11. 联盟节点运行[设置矿机运行模式]，将矿机设置为自动记账，持续生成新的区块

## 接口描述

注：使用 Postman 模拟操作时，目标地址默认为 http://127.0.0.1:2102

### 创建联盟根私钥

Post Input

```json
{
  "method": "sys.aliance.create",   //命令字：创建联盟根私钥
  "wid": "primary",                 //钱包编号，固定为"primary"
  "params": [
    "aliancename",                  //联盟名称
    "password",                     //备份密码，联盟节点启动时，需要提供此密码以读取私钥备份文件
  ]
}
```

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": "testnet-genesis-bookman.encrypt", //私钥备份文件名称。命令执行后，会在项目根目录下生成同名私钥备份文件
  "sig": "*"
}
```

**联盟节点从盟主处获取该文件后，改名为 testnet-genesis.encrypt 并置于项目根目录下，携带备份密码参数启动节点，利用该私钥备份文件正确设置根私钥**

### 生成信道密钥

Post Input

```json
{
  "method": "sys.aliance.gettoken", //命令字：生成信道密钥
  "wid": "primary",                 //钱包编号，固定为"primary"
  "params": [
    1,                              //联盟节点编号(Int)。同一个联盟成员可能运行多个节点，需要对节点统一编号
    "aliancename",                  //(可选)联盟名称。如果置空，表示生成盟主自身的信道密钥
  ]
}
```

**此命令只在盟主节点上执行，在联盟节点上执行无意义**

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {
    "aliancename": "bookman",       //联盟名称
    "sn": 1,                        //联盟编号
    "prv": "*",                     //信道密钥的私钥
    "pub": "*",                     //信道密钥的公钥
    "address": "*"                  //信道密钥对应地址
  },
}
```

**返回值中的'信道密钥的私钥'用于[设置信道密钥]命令中，联盟节点信道密钥由盟主统一分发**

### 设置信道密钥

Post Input

```json
{
  "method": "sys.aliance.settoken", //命令字：设置信道密钥
  "wid": "primary",                 //钱包编号，固定为"primary"
  "params": [
    "prvKey",                       //(可选)信道密钥的私钥。如果留空，则返回先前设置的密钥，如先前未设置，返回错误码-1
  ]
}
```

**联盟节点收到盟主分发的信道密钥后，执行此命令设置自身信道密钥**

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {
    "prv": "*",                     //信道密钥的私钥
    "pub": "*",                     //信道密钥的公钥
    "address": "*"                  //信道密钥对应地址
  },
}
```

### 添加可信信道

Post Input

```json
{
  "method": "sys.aliance.addpeer",  //命令字：添加可信信道
  "wid": "primary",                 //钱包编号，固定为"primary"
  "params": [
    "host",                         //信道的主机地址(IP:PORT)。这里信道指当前节点信任的联盟节点
    "pubKey",                       //信道密钥的公钥
  ]
}
```

**第三方联盟节点在正确设置自身信道密钥，且被当前节点成功添加后，才能和当前节点顺利组网**

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {
    "host": "127.0.0.1:2100",     //信道的主机地址
    "key": "*"                    //信道密钥的公钥
  },
}
```

### 查看选举地址

Post Input

```json
{
  "method": "miner.getaddr.admin",  //命令字：查看选举地址
  "wid": "primary",                 //钱包编号，固定为"primary"
  "params": [
  ]
}
```

**盟主节点天然具备记账权，不需要通过选举获得记账权，也不需要公布自己的选举地址**

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": "node.address",         //联盟节点的选举地址，同时也是记账奖励接收地址
}
```

### 选举节点

**选举结果需要经过一个周期后才能生效**

Post Input

```json
{
  "method": "vote.send",    //命令字：选举节点
  "wid": "primary",         //钱包编号，固定为"primary"
  "params": [
    "node.address",         //联盟节点官方地址
    100000000,              //投票动用的通证金额
  ]
}
```

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {
    "hash": "fa73e77e685551912f68e5afc2f4afae3638640b9bf004c63756f908b5ea51f4",
    "height": -1,
    "block": null,
    "date": "2020-11-19T16:02:02Z",
    "confirmations": 0,
    "tx": "*"
  },
  "sig": "*"
}
```

### 选举验证

Post Input

```json
{
  "method": "vote.check",   //命令字：选举验证
  "wid": "primary",         //钱包编号，固定为"primary"
  "params": [
    "node.address",         //待验证的联盟节点票选地址(同时也是其记账奖励地址)
  ]
}
```

Post Output

```json
```

### 设置矿机运行模式

Post Input

```json
{
  "method": "miner.set.admin",  //命令字：设置矿机运行模式
  "wid": "primary",             //钱包编号，固定为"primary"
  "params": [
    true,                       //指定矿机模式 true 自动记账 false 手动记账
  ]
}
```

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": true,             //矿机当前运行模式
}
```

## 单元测试

详见 test/节点选举.js

注：使用Mocha进行单元测试时，执行如下指令:

```bash
# 安装Mocha(如果尚未安装)
npm i mocha@5.2.0 -g
# 运行单元测试
mocha test/节点选举
```

## FAQ
