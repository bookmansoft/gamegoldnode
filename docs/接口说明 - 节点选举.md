# 节点选举接口说明

## 业务流程描述

1. 盟主主力节点调用[创建盟友根私钥]为各个盟友创建根私钥，生成对应文件并分发给各个盟友。盟主掌握所有盟友根私钥
2. 盟友主力节点正确导入联盟根私钥文件。注意只是主力节点，盟友辅助节点可以自行生成个性化根私钥
3. 盟主主力节点调用[生成信道密钥]生成所有信道密钥，列表密钥和节点主机地址(含盟主和盟友的全部主力/辅助节点)
4. 盟主主力节点调用[设置信道密钥]设置信道密钥。盟主主力节点天然拥有选举权，不需要通过投票获取
5. 盟友节点调用[生成信道密钥]生成自身信道密钥(因生成规则一致，与盟主节点异步生成密钥一致)，调用[设置信道密钥]进行设置
6. 盟友节点按照盟主主力节点给出的信道列表，调用[添加可信信道]添加信道
7. 各节点设置合适的种子节点列表，之后就可以相互间自动组成对等网络，彼此间展开端到端加密通信
8. 盟友节点调用[查看选举地址]查看选举地址(记账奖励地址)并公布。盟友辅助节点可将选举地址设为和主力节点一致
9. 盟友节点运行[选举节点]，利用自身通证为指定选举地址投票，票选出下一个周期的记账节点
10. 盟友节点运行[验证节点]，查看指定选举地址是否当选
11. 当选节点运行[设置矿机运行模式]，将矿机设置为自动记账，持续生成新的区块

## 接口描述

注：使用 Postman 模拟操作时，目标地址默认为 http://127.0.0.1:2102

### 创建盟友根私钥

Post Input

```json
{
  "method": "sys.aliance.create",   //命令字：创建盟友根私钥
  "wid": "primary",                 //钱包编号，固定为"primary"
  "params": [
    "aliancename",                  //盟友的组织称谓
    "password",                     //备份密码，盟友节点启动时，需要提供此密码以读取私钥备份文件
  ]
}
```

**此命令只在盟主主力节点上执行，在其它节点上执行无意义**

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": "testnet-genesis-bookman.encrypt", //私钥备份文件名称。命令执行后，会在项目根目录下生成同名私钥备份文件
  "sig": "*"
}
```

**盟友从盟主处获取该文件后，改名为 testnet-genesis.encrypt 并置于主力节点项目根目录下，携带备份密码参数启动节点，利用该私钥备份文件正确设置根私钥**

### 生成信道密钥

Post Input

```json
{
  "method": "sys.aliance.gettoken", //命令字：生成信道密钥
  "wid": "primary",                 //钱包编号，固定为"primary"
  "params": [
    1,                              //联盟节点编号(Int)。同一个联盟成员可能运行多个节点，需要对节点统一编号
    "aliancename",                  //(可选)联盟名称。如果置空，表示生成盟主自身的信道密钥
  ]
}
```

**此命令只在盟主主力节点上执行，在其它节点上执行无意义**

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {
    "aliancename": "bookman",       //联盟名称
    "sn": 1,                        //联盟编号
    "prv": "*",                     //信道密钥的私钥
    "pub": "*",                     //信道密钥的公钥
    "address": "*"                  //信道密钥对应地址
  },
}
```

**返回值中的'信道密钥的私钥'用于[设置信道密钥]命令中。盟友节点信道密钥可自行生成，无需盟主分发**

### 设置信道密钥

Post Input

```json
{
  "method": "sys.aliance.settoken", //命令字：设置信道密钥
  "wid": "primary",                 //钱包编号，固定为"primary"
  "params": [
    "prvKey",                       //(可选)信道密钥的私钥。如果留空，则返回先前设置的密钥，如先前未设置，返回错误码-1
  ]
}
```

**盟友节点自行生成一致的信道密钥后，执行此命令设置自身信道密钥**

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {
    "prv": "*",                     //信道密钥的私钥
    "pub": "*",                     //信道密钥的公钥
    "address": "*"                  //信道密钥对应地址
  },
}
```

### 添加可信信道

Post Input

```json
{
  "method": "sys.aliance.addpeer",  //命令字：添加可信信道
  "wid": "primary",                 //钱包编号，固定为"primary"
  "params": [
    "host",                         //信道的主机地址(IP:PORT)。这里信道指当前节点信任的盟友节点
    "pubKey",                       //信道密钥的公钥
  ]
}
```

**第三方节点和当前节点在正确设置自身信道密钥且相互添加为可信信道后，才能彼此顺利组网**

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {
    "host": "127.0.0.1:2100",     //信道的主机地址
    "key": "*"                    //信道密钥的公钥
  },
}
```

### 查看选举地址

Post Input

```json
{
  "method": "miner.getaddr.admin",  //命令字：查看选举地址
  "wid": "primary",                 //钱包编号，固定为"primary"
  "params": [
  ]
}
```

**盟友主力节点查看后公布此地址，等待他人选举。盟友辅助节点统一将选举地址设为和主力节点一致**
**盟主节点天然具备记账权，不需要通过选举获得记账权，也不需要公布自己的选举地址**

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": "node.address",         //盟友节点的选举地址，同时也是记账奖励接收地址
}
```

### 设置选举地址

**请不要轻易调用此命令**

Post Input

```json
{
  "method": "miner.setaddr.admin",  //命令字：设置选举地址
  "wid": "primary",                 //钱包编号，固定为"primary"
  "params": [
    "node.address",                 //盟友主力节点的选举地址，同时也是该组织统一的记账奖励接收地址
  ]
}
```

**盟友主力节点查看后公布此地址，等待他人选举。盟友辅助节点统一将选举地址设为和主力节点一致**
**盟主节点天然具备记账权，不需要通过选举获得记账权，也不需要公布自己的选举地址**

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": null,
  "sig": null
}{
  "code": 0,
  "error": null,
  "result": 
}
```

### 选举节点

**选举结果需要经过一个周期后才能生效**

Post Input

```json
{
  "method": "vote.send",    //命令字：选举节点
  "wid": "primary",         //钱包编号，固定为"primary"
  "params": [
    "node.address",         //盟友公布的统一的选举地址
    100000000,              //投票动用的通证金额
  ]
}
```

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {
    "hash": "*",                      //记录所在交易的哈希值
    "height": -1,                     //选举记录链上位置，-1表示尚未上链
    "block": null,                    //选举记录所在区块哈希，NULL表示尚未上链
    "date": "2020-11-19T16:02:02Z",   //选举记录产生时间
    "confirmations": 0,               //确认数，为0表示尚未确认(尚未上链)
    "tx": "*"                         //记录所在交易的原始数据
  },
  "sig": "*"
}
```

### 选举验证

Post Input

```json
{
  "method": "vote.check",   //命令字：选举验证
  "wid": "primary",         //钱包编号，固定为"primary"
  "params": [
    "node.address",         //待验证的选举地址
  ]
}
```

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {
    "address": "tb1q9vw3vdf0jnscl0upkeksuk8t5lfzeg7ztpxlt7",  //选举地址
    "rank": 2,                                                //排名
    "vote": 21000,                                            //票数
    "result": true,                                           //是否当选
    "block": 11                                               //累计记账数
  },
  "sig": "*"
}
```

### 设置矿机运行模式

Post Input

```json
{
  "method": "miner.set.admin",  //命令字：设置矿机运行模式
  "wid": "primary",             //钱包编号，固定为"primary"
  "params": [
    true,                       //指定矿机模式 true 自动记账 false 手动记账
  ]
}
```

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": true,             //矿机当前运行模式
}
```

## 单元测试

详见 test/节点选举.js

注：使用Mocha进行单元测试时，执行如下指令:

```bash
# 安装Mocha(如果尚未安装)
npm i mocha@5.2.0 -g
# 运行单元测试
mocha test/节点选举
```

## FAQ
