# 众筹业务流程

## 业务流程主干描述

主要的业务流程包括:
1. 发起众筹，以人民币标注众筹凭证单位价格。这个阶段文创产品尚未投产，本质上是文创产品的预售。
2. 允许用户使用人民币直接购买众筹凭证。
3. 上架文创产品，允许用户使用众筹凭证兑换**对应的**文创产品, 本质上是兑现预售承诺。
4. 允许用户使用人民币购买文创产品。这个阶段，持有众筹凭证的用户将获得一定积分奖励。
5. 允许用户使用积分购买已上架的**任意**文创产品。

整个过程中，平台积分和人民币是一比一固定比率，但不允许人民币购买平台积分，平台积分也不能兑换人民币

### 发起众筹

```js
//注册一个新的CP
let cp = {name: 'press'};
await remote.execute('cp.create', [cp.name, '127.0.0.1']);
await remote.execute('miner.generate.admin', [1]);
let ret = await remote.execute('cp.byName', [cp.name]);
cp.id = ret.result.cid;
cp.addr = ret.result.pubAddress;
```

```json
//ret.result
{
    "cid": "ec47d590-9ea3-11ea-9012-756e0743b925",
    "name": "press",
    "pubAddress": "tb1qpvzsmds4a4lz2jsjm8zwy0csumy2uvjg92f5km",
    "height": 194,
    "status": 1
}
```

```js
//发行众筹
await remote.execute('stock.offer', [cp.id, 1000, 1000]);
await remote.execute('miner.generate.admin', [1]);
let ret = await remote.execute('cp.byName', [cp.name]);
assert(ret.result.stock.sum === 1000);
assert(ret.result.stock.price === 1000);
```

```json
{
    "cid": "e69ff1b0-9e9c-11ea-8a12-035079722b38",
    "name": "press",
    "stock": {
      "hHeight": 194,
      "hSum": 0,
      "hPrice": 0,
      "hBonus": 0,
      "hAds": 0,
      "sum": 1000,
      "price": 1000,
      "height": 194
    },
    "height": 194,
    "status": 1
}
```

### 购买众筹凭证

```js
//创建用户对象
let alice = {name:'alice'};
//当alice完成人民币支付后，为其充值平台积分
await remote.execute('tx.create', [{'sendnow':true}, [{'value':500000000, 'account': alice.name}]]);
//可以立即查询alice名下余额
await remote.execute('balance.all', [alice.name]);
//系统作为alice的代理，使用其名下平台币为其购买众筹凭证
await remote.execute('stock.purchase', [cp.id, 100, alice.name]);
//数据上链
await remote.execute('miner.generate.admin', [1]);
//查询alice的凭证余额等于100
ret = await remote.execute('stock.list.wallet', [[['cid', cp.id], ['account', alice.name]]]);
assert(ret.result.list[0].sum === 100);
```

### 众筹凭证兑换商品

```js
//将alice名下众筹凭证转给厂商以兑换商品，注意需要支付手续费，因此alice账户需要留有一定积分
await remote.execute('stock.send', [cp.id, 100, cp.addr, alice.name]);
```

### 销售商品&积分奖励

```js
//bob使用人民币支付，支付成功后系统为其增加相应积分，并使用积分购买商品, 注意订单号不能重复
//此处会为众筹凭证持有者分润
let bob = {name:'bob'};
let ret = await remote.execute('order.pay', [cp.id, bob.name, "oid-bob-"+ uuid().slice(0,28), 100000000, bob.name]);
ret = await remote.execute('order.query.wallet', [[['cid', cp.id]], bob.name]);
```

### 积分购买商品

```js
//alice使用积分支付货款, 注意订单号不能重复
//此处会为众筹凭证持有者分润
let ret = await remote.execute('order.pay', [cp.id, alice.name, "oid-alice-"+ uuid().slice(0,26), 100000000, alice.name]);
ret = await remote.execute('order.query.wallet', [[['cid', cp.id]], alice.name]);
```

## 单元测试

test/online/stock.js