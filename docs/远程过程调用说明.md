# 百谷王链远程过程调用说明

百谷王区块链引擎(Vallnet Blockchain Engine)提供了Restful风格的远程调用接口，为第三方软件服务商集成区块链功能提供便利。本文档分别从安全连接、接口描述(功能说明和出入参数)、功能测试等方面展开详细描述。

## 术语解释

1. 全节点：百谷王区块链引擎核心组件，独立运行于后台服务器或云主机上，可通过对等网络组网技术，和其它遵循兼容共识的全节点一道构成可水平扩展的链库。
2. VR: Vallnet Restful RPC(百谷王链远程调用接口)的简称
3. HMAC: 一种密钥分发机制，大幅降低了中间人攻击风险
4. 终端: 指代尝试通过VR和全节点交互的外部信息系统


6. 上行报文签名
Restful Post Body 中的必填字段

## 安全连接

1. 基础校验
VR调用中，必须在 Post Headers 中填写[Authorization]字段, 它由如下参数通过Base64转换而成：
- "Username": "bitcoinrpc"
- "Password": "bookmansoft"
可以在 Postman 中设置Authorization相关参数，软件会自动处理包含对应Headers字段值
也可由如下代码生成:
```js
    let username = 'bitcoinrpc', password = 'bookmansoft';
    const auth = `${username}:${password}`;
    const data = Buffer.from(auth, 'utf8');
    headers['Authorization'] = `Basic ${data.toString('base64')}`;
```

2. HMAC
VR采用HMAC算法避免中间人攻击(MITM), dev-mode下可忽略:
  21. 全节点为终端制作证书并离线分发给终端，证书含[终端号]+[令牌尾]。注意证书信息不能泄露给第三方
  22. 终端向全节点发起在线请求并上传[终端号]，全节点生成随机[令牌头]下发给终端。注意[令牌头]有时效性
  23. 终端自行用[令牌头]和[令牌尾]合成[令牌]，在后续的RPC请求中始终附加[终端号]+[令牌]
  24. 在[令牌头]失效前，终端负责申请新的[令牌头]并刷新令牌

3. 数据报文签名校验
VR的上下行报文都采用签名验证模式, dev-mode下可忽略:
  31. 发送方对上行报文所有字段排序后抽取成KV字符串
  32. 发送方使用椭圆曲线算法和令牌衍生密钥对KV字符串签名，将签名数据作为sig字段附在报文末尾
  33. 接收方使用同样方式演算sig字段后进行校验

4. ACL
VR采用访问控制列表机制，控制终端远程访问能力, 使用超级终端号('xxxxxxxx-vallnet-root-xxxxxxxxxxxxxx')时可忽略

5. 加密传输
收发方对报文应用Chacha或AES对称加解密方案，进一步提高安全性和隐私性, 此功能属于定制方案, 不包含在引擎通用版中

## 连接测试

@note 使用系统自带的行命令工具和 Postman 工具软件执行相关测试
@note dev-mode 模式下可以跳过步骤1/2/3, 直接执行步骤4

1. 系统管理员通过行命令为终端生成并颁发证书

```bash
# 以终端号为输入参数执行命令. 注意 dev-mode=true 直接返回[令牌尾]即token字段, 否则要通过解密 encry 得到
vc sys.createAuthToken xxxxxxxx-vallnet-root-xxxxxxxxxxxxxx
```

[Response]
```json
 [
    {
      "cid": "xxxxxxxx-vallnet-root-xxxxxxxxxxxxxx",
      "encry": "adakaeeoconigoelheknmmggajiogcldnjggadlahofjoiakmdldjeldjnfhmgmjhnlopoemodbmhiiccffhcmnhdigmnpfaolmfibfonjphbgkimcejcplemfpeobnnfghifgkhfehbbgeanefdpghghpkbkopn",
      "token": "03252fcf8061d221ad0a066d3e8447fd1e6184874a2fdc02eeced5c47d14bd8462"
    }
]
```

2. 终端向全节点申请[令牌头]

[Request]
```bash
POST http://localhost:17332

Headers:
    Authorization: Basic Yml0Y29pbnJwYzpib29rbWFuc29mdA==
    Content-Type: application/json

Body: 
    raw
    {
	    "method": "token.random",
	    "params": ["xxxxxxxx-vallnet-root-xxxxxxxxxxxxxx"]
    }
```

[Response]
```json
{
  "code": 0,
  "error": null,
  "result": "3045022100ab6224b43bb66ea01676bcfe525fc3b5f3a789f1b711a38750d228f14bb0077b02202212e02118cf2ace64061cbd53fd051404875ff965464bded02269d2008c7080"
}
```

3. 终端本地计算最终的访问令牌, 注意每次[令牌头]发生更新都需要重新计算

如下为计算最终令牌的js代码示例，其它语言可仿制其流程:
```js
// 终端获颁证书中的[令牌尾]
let token = '03252fcf8061d221ad0a066d3e8447fd1e6184874a2fdc02eeced5c47d14bd8462';
// token.random 的返回结果，即[令牌头]
let random = '3045022100ab6224b43bb66ea01676bcfe525fc3b5f3a789f1b711a38750d228f14bb0077b02202212e02118cf2ace64061cbd53fd051404875ff965464bded02269d2008c7080';
// 计算获得最终的令牌'e1624d5139cf1971ed05cb61be8a7889858ae141fe0d6a0e5414309917e2d971'
let calc = crypto.createHmac('sha256', random).update(token).digest().toString('hex');
```

可以使用行命令模拟计算:
```bash
gg hmac.calc xxxxxxxx-vallnet-root-xxxxxxxxxxxxxx 03252fcf8061d221ad0a066d3e8447fd1e6184874a2fdc02eeced5c47d14bd8462 3045022100ab6224b43bb66ea01676bcfe525fc3b5f3a789f1b711a38750d228f14bb0077b02202212e02118cf2ace64061cbd53fd051404875ff965464bded02269d2008c7080
```

```json
{ 
    "cid"   : "xxxxxxxx-vallnet-root-xxxxxxxxxxxxxx",
    "token" : "03aee0ed00c6ad4819641c7201f4f44289564ac4e816918828703eecf49e382d08",
    "random": "3045022100f356e342195d635b01d963de607a4967499003db1937ce961e6cca6922df98c8022029523cdd3753aa378511e2282b35148184ff3fbc91f18ff9da2cbb69d01979c3",
    "calc"  : "52b3ee69d9d62948208288e47bce34cd4c1a9b8d2a34d48eef25657fe6650078" 
}
```

4. 终端携带终端号和访问令牌，向全节点申请执行远程命令

```bash
POST http://localhost:17332

Headers:
    Authorization: Basic Yml0Y29pbnJwYzpib29rbWFuc29mdA==
    Content-Type: application/json

Body: 
    raw
    {
        # 命令字 - 查询当前链库概要信息
        "method":"block.tips",
        # 钱包编号 
        "wid": "primary",
        # 终端号
        "cid": "xxxxxxxx-vallnet-root-xxxxxxxxxxxxxx",
        # (dev-mode模式下置空)访问令牌，就是第2步计算出来的 calc 字段值
        "token": "52b3ee69d9d62948208288e47bce34cd4c1a9b8d2a34d48eef25657fe6650078",
        # 命令参数数组
        "params":[],
        # (dev-mode模式下置空)上行报文签名，生成流程上文有讲述
        "sig":""
    }
```

如果调用返回如下错误，很可能是 random 过时，此时需要重新从步骤2开始执行
```json
{
    "type": "HmacError",
    "message": "Hmac Auth failure."            
}
```

## 功能接口列表

```json
//查询当前链库概要信息
{
    "method":"block.tips",
    "params":[],
}

//手工产生一个新的区块
{
    "method":"miner.generate.admin",
    "params":[1],
}

//注册一个厂商, 指定 15% 的媒体分成
{
    "method":"cp.create",
    "params":["cpName", "127.0.0.1,,slg,15"],
}

//发起一个众筹，指定CP编号、发行数量、发行价格
{
    "method":"stock.offer",
    "params":["cpId", 1000, 1000],
}

//Alice购买已发行的凭证
{
    "method":"stock.purchase",
    "params":["cpId", 100, "Alice"],
}

//Alice查询持有的凭证列表
{
    "method":"stock.list.wallet",
    "params":[[["account","Alice"]]]
}

//查询凭证流水, type 的含义如下
//Offer: 1,         发行凭证
//Purchase: 2,      购买发行的凭证        
//Send: 3,          无偿转让凭证          
//Bonus: 4,         凭证分成              
//Ads: 5,           媒体分成              
//Bid: 6,           有偿转让凭证          
//Auction: 7,       购买有偿转让的凭证
{
    "method":"stock.record.wallet",
    "params":[2, "cpId"],
}
```
