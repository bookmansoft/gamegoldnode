# 百谷王链远程过程调用说明

百谷王区块链引擎(Vallnet Blockchain Engine)提供了Restful风格的远程调用接口，为第三方软件服务商集成区块链功能提供便利。本文档分别从安全连接、接口描述(功能说明和出入参数)、功能测试等方面展开详细描述。

## 术语解释

1. 全节点：百谷王区块链引擎核心组件，独立运行于后台服务器或云主机上，可通过对等网络组网技术，和其它遵循兼容共识的全节点一道构成可水平扩展的链网。
2. VR: Vallnet Restful RPC(百谷王链Restful远程接口)的简称
3. HMAC: 一种密钥分发机制，大幅降低了中间人攻击风险
4. 终端: 指代尝试通过VR和全节点交互的外部信息系统

## 安全连接

VR采用HMAC算法避免MITM，具体流程描述如下:
1. 全节点为终端制作证书并离线分发给终端，证书含[终端号]+[令牌尾]。注意证书信息不能泄露给第三方
2. 终端向全节点发起在线请求并上传[终端号]，全节点生成随机[令牌头]下发给终端。注意[令牌头]有时效性
3. 终端自行用[令牌头]和[令牌尾]合成[令牌]，在后续的RPC请求中始终附加[终端号]+[令牌]
4. 在[令牌头]失效前，终端负责申请新的[令牌头]并刷新令牌

## 接口描述

## 功能测试

使用行命令工具和 Postman 执行相关测试

1. 系统管理员通过行命令为终端生成并颁发证书

```bash
# 以终端号为输入参数执行命令. 注意 dev-mode=true 直接返回[令牌尾]即token字段, 否则要通过解密 encry 得到
vc sys.createAuthToken xxxxxxxx-vallnet-root-xxxxxxxxxxxxxx
```

[Response]
```json
 [
    {
      "cid": "xxxxxxxx-vallnet-root-xxxxxxxxxxxxxx",
      "encry": "adakaeeoconigoelheknmmggajiogcldnjggadlahofjoiakmdldjeldjnfhmgmjhnlopoemodbmhiiccffhcmnhdigmnpfaolmfibfonjphbgkimcejcplemfpeobnnfghifgkhfehbbgeanefdpghghpkbkopn",
      "token": "03252fcf8061d221ad0a066d3e8447fd1e6184874a2fdc02eeced5c47d14bd8462"
    }
]
```

2. 终端向全节点申请[令牌头]

[Request]
```bash
POST http://localhost:17332

Headers:
    # 由如下参数通过Base64转换而成，可直接在 Postman 中设置，软件会自动转换成 Authorization 参数：
    #   "Username": "bitcoinrpc"
    #   "Password": "bookmansoft"
    Authorization: Basic Yml0Y29pbnJwYzpib29rbWFuc29mdA==
    Content-Type: application/json

Body: 
    raw
    {
	    "method": "token.random",
	    "params": ["xxxxxxxx-vallnet-root-xxxxxxxxxxxxxx"]
    }
```

**Authorization 字段数值也可由如下代码生成**
```js
const auth = `${this.auth.username}:${this.auth.password}`;
const data = Buffer.from(auth, 'utf8');
headers['Authorization'] = `Basic ${data.toString('base64')}`;
```

[Response]
```json
{
  "code": 0,
  "error": null,
  "result": "3045022100ab6224b43bb66ea01676bcfe525fc3b5f3a789f1b711a38750d228f14bb0077b02202212e02118cf2ace64061cbd53fd051404875ff965464bded02269d2008c7080"
}
```

3. 终端本地计算最终的访问令牌, 注意每次[令牌头]发生更新都需要重新计算

如下为计算最终令牌的js代码示例，其它语言可仿制其流程:
```js
// 终端获颁证书中的[令牌尾]
let token = '03252fcf8061d221ad0a066d3e8447fd1e6184874a2fdc02eeced5c47d14bd8462';
// token.random 的返回结果，即[令牌头]
let random = '3045022100ab6224b43bb66ea01676bcfe525fc3b5f3a789f1b711a38750d228f14bb0077b02202212e02118cf2ace64061cbd53fd051404875ff965464bded02269d2008c7080';
// 计算获得最终的令牌'e1624d5139cf1971ed05cb61be8a7889858ae141fe0d6a0e5414309917e2d971'
let calc = crypto.createHmac('sha256', random).update(token).digest().toString('hex');
```

可以使用行命令模拟计算:
```bash
gg hmac.calc xxxxxxxx-vallnet-root-xxxxxxxxxxxxxx 03252fcf8061d221ad0a066d3e8447fd1e6184874a2fdc02eeced5c47d14bd8462 3045022100ab6224b43bb66ea01676bcfe525fc3b5f3a789f1b711a38750d228f14bb0077b02202212e02118cf2ace64061cbd53fd051404875ff965464bded02269d2008c7080
```

```json
{ 
    "cid"   : "xxxxxxxx-vallnet-root-xxxxxxxxxxxxxx",
    "token" : "03aee0ed00c6ad4819641c7201f4f44289564ac4e816918828703eecf49e382d08",
    "random": "3045022100f356e342195d635b01d963de607a4967499003db1937ce961e6cca6922df98c8022029523cdd3753aa378511e2282b35148184ff3fbc91f18ff9da2cbb69d01979c3",
    "calc"  : "52b3ee69d9d62948208288e47bce34cd4c1a9b8d2a34d48eef25657fe6650078" 
}
```

4. 终端携带终端号和访问令牌，向全节点申请执行远程命令

```bash
POST http://localhost:17332

Headers:
    Authorization: Basic Yml0Y29pbnJwYzpib29rbWFuc29mdA==
    Content-Type: application/json

Body: 
    raw
    {
        # 命令字 - 查询当前链网概要信息
        "method":"block.tips",
        # 钱包编号 
        "wid": "primary",
        # 终端号
        "cid": "xxxxxxxx-vallnet-root-xxxxxxxxxxxxxx",
        # 访问令牌，就是第2步计算出来的 calc 字段值
        "token": "52b3ee69d9d62948208288e47bce34cd4c1a9b8d2a34d48eef25657fe6650078",
        # 命令参数数组
        "params":[],
        # 上行报文签名，其计算流程另行说明，在dev-mode下可以忽略
        "sig":""
    }
```

如果调用返回如下错误，很可能是 random 过时，此时需要重新从步骤2开始执行
```json
{
    "type": "HmacError",
    "message": "Hmac Auth failure."            
}
```

变更Body内容以执行不同指令，例如产生一个新的区块
```json
    {
        "method":"miner.generate.admin",
        "wid": "primary",
        "cid": "xxxxxxxx-vallnet-root-xxxxxxxxxxxxxx",
        "token": "52b3ee69d9d62948208288e47bce34cd4c1a9b8d2a34d48eef25657fe6650078",
        "params":[1],
    }
```
