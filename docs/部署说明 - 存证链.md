# 存证链部署说明

《百谷王链》是集成了新型密码学的分布式数据库软件，同时支持公链/许可链模式

常见的联盟链/私链都属于许可链，许可链和公链的差异性体现在如下几点：
1. 在许可链上，新的节点要成为目标对等网络的组成节点，需要持有许可链治理机构颁发的节点证书，或者通过社区选举得到节点证书
2. 在许可链上，对等节点间通讯需要加密，防止数据外泄
3. 许可链节点数量相对较少，交易速度要求较高

意愿存证链是典型的联盟链，遵循上述基本原则，部署步骤如下:
1. 部署盟主节点
盟主主力节点是指定存证链的第一个节点，该节点将确定一系列共识基础，输出供后续节点使用的共识参数
盟主主力节点部署成功后，也就意味着指定存证链正式运行。盟主可以随时扩展自己的辅助节点
2. 盟友部署节点
各个盟友启动自己旗下节点，通过合理配置，使得所有节点自动组成一个对等网络，作为指定存证链的底层设施

更为详细的步骤描述如下：
1. 盟主主力节点调用[创建盟友根私钥]为各个盟友创建根私钥，生成对应文件并分发给各个盟友。盟主掌握所有盟友根私钥
2. 盟友主力节点正确导入联盟根私钥文件。注意只是主力节点，盟友辅助节点可以自行生成个性化根私钥
3. 盟主主力节点调用[生成信道密钥]生成所有信道密钥，列表密钥和节点主机地址(含盟主和盟友的全部主力/辅助节点)
4. 盟主主力节点调用[设置信道密钥]设置信道密钥。盟主主力节点天然拥有选举权，不需要通过投票获取
5. 盟友节点调用[生成信道密钥]生成自身信道密钥(因生成规则一致，与盟主节点异步生成密钥一致)，调用[设置信道密钥]进行设置
6. 盟友节点按照盟主主力节点给出的信道列表，调用[添加可信信道]添加信道
7. 各节点设置合适的种子节点列表，之后就可以相互间自动组成对等网络，彼此间展开端到端加密通信
8. 盟友节点调用[查看选举地址]查看选举地址(记账奖励地址)并公布。盟友辅助节点可将选举地址设为和主力节点一致
9. 盟友节点运行[选举节点]，利用自身通证为指定选举地址投票，票选出下一个周期的记账节点
10. 盟友节点运行[验证节点]，查看指定选举地址是否当选
11. 当选节点运行[设置矿机运行模式]，将矿机设置为自动记账，持续生成新的区块

注：顶层服务提供商可以考虑实现一个配套的网管系统，调度管理所有节点
注：使用 Postman 模拟操作时，目标地址默认为 http://127.0.0.1:2102

## 部署盟主节点

```bash
node bin/node --bip150=true --bip151=true --genesis=bookmansoft --network=testnet
```

启动参数说明：
| Name        | Type    | Presence | Description                                                     |
|-------------|---------|----------|-----------------------------------------------------------------|
| genesis     | bool    | required | 指示正在开启一个创世流程，内容格式'pwd,language,bits'              |
| network     | string  | optional | 指示归属子网类型, 默认为'main'                                    |
| bip150      | bool    | required | 指示启动节点授权认证                                              |
| bip151      | bool    | required | 指示启动流式加密通讯                                              |

[盟主节点]带[genesis]参数首次启动后，会在根目录下生成创世参数文件 `testnet-genesis.params`，其它组网节点首次启动前，必须将其置于项目根目录下，这样启动后才能生成和盟主节点完全一致的创世节点，这是顺利组网的前提条件。[genesis]携带解密密钥文件或构造新的密钥文件的参数
[盟主节点]启动后，会在根目录下生成 `testnet-genesis.encrypt` 创世密钥文件，必须本人妥善保管，不得外泄
[盟主节点]使用[network]参数规定子网类型，子网类型相同的节点组成一个特定对等网络(称之为链态)，因此子网类型决定节点归属。本期项目测试阶段使用子网类型'testnet'，实际部署使用子网类型'evidence' 
如果项目先后以多种子网类型运行，将会在[.gamegold]目录下形成多个子网类型数据目录
本地调测节点期间，如需删库操作，可以关闭节点、整体删除指定子网类型数据目录、再重新运行节点以生成全新数据目录，但务请如果该

[盟主节点]启动后调用如下命令查看己方组网令牌：

Input

```bash
vc sys.aliance.settoken
```

Output

```json
{
    "prv": "77fd3beec28d0eb2b9aeaa0d67dc07251403849891451282ed563dc7176221e9",      //令牌私钥
    "pub": "02de18b045d45b310ce683b4bb8f9936c29f34520c5f868e9359bac280c9b67cd8",    //令牌公钥
    "address": "tb1qegxh996mj26r72xl4tqpu38rhjpwpyuj3gu7gr"                         //令牌地址
}
```

必须将节点地址(host, 例如 127.0.0.1:2100)、令牌公钥(pubkey)分享给其它联盟节点，其它联盟节点分别执行如下命令来为其开放连接:

```bash
vc sys.aliance.addpeer host pubkey 
```

联盟节点如需升级为记账节点，还需公布令牌地址供其它节点选举

**盟主节点也必须执行上述命令，完成对联盟节点的认证**

## 部署后续节点

启动参数说明：
| Name        | Type    | Presence | Description                                                     |
|-------------|---------|----------|-----------------------------------------------------------------|
| genesis     | bool    | required | 指示正在开启一个创世流程，内容格式'pwd,language,bits'              |
| network     | string  | optional | 指示归属子网类型, 默认为'main'                                    |
| bip150      | bool    | optional | 指示启动节点授权认证                                              |
| bip151      | bool    | optional | 指示启动流式加密通讯                                              |
| only        | string  | optional | 指示盟主节点主机地址，如 127.0.0.1:2100                           |
| port-offset | number  | optional | 指示监听端口偏移量，用于单机多节点部署                             |
| prefix      | number  | optional | 指示数据目录存储路径，默认为 .gamegold/{子网类型}                  |

[后续节点]启动时必须带 --genesis 参数，系统检测到该参数后，会尝试读取根目录下的 `test-genesis.params` 创世参数文件以构造对应的创世区块，该文件是目标链态的[盟主节点]生产创世区块时转储的创世参数文件，两者必须完全匹配，节点间方能实现同步
[后续节点]启动后，会尝试读取根目录下的 `testnet-genesis.encrypt` ，读取并设置本地钱包的根私钥。[genesis]携带解密密钥文件或构造新的密钥文件的参数
[后续节点]启动时的 --network 参数必须与盟主节点保持一致
[后续节点]启动时需要携带 --only 参数以指定盟主节点地址(例如 127.0.0.1:2100)
[后续节点]如果在单台物理机上做多个部署，需要携带 --port-offset 参数指定监听端口偏移量(10、20...90)以区分不同节点

## 联盟节点开放服务接口

按照《使用手册》远程过程调用的说明，按需调用节点的服务接口，以[查询链态高度]为例：

Post Input

```json
{
  "method": "block.tips",   //命令字：查询链态高度
  "wid": "primary",         //钱包编号，默认"primary"
  "params": [
  ]
}
```

Post Output

```json
{
    "code": 0,                    //返回码，零表示正常
    "error": null,                //错误信息，NULL表示正常
    "result": [
        {
            "height": 139,        //最新区块高度
            "hash": "*",          //最新区块哈希
            "status": "active"    //分支状态
        }
    ],
    "sig": "*"                    //报文签名
}
```

### 创建盟友根私钥

Post Input

```json
{
  "method": "sys.aliance.create",   //命令字：创建盟友根私钥
  "wid": "primary",                 //钱包编号，固定为"primary"
  "params": [
    "aliancename",                  //盟友的组织称谓
    "password",                     //备份密码，盟友节点启动时，需要提供此密码以读取私钥备份文件
  ]
}
```

**此命令只在盟主主力节点上执行，在其它节点上执行无意义**

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {
    "nodeid": "",                                   //节点编号
    "aliancename": "",                              //联盟名称
    "publicKey": "",                                //联盟根密钥的公钥HEX字符串(length=66)，可作为联盟节点标识
    "file": "testnet-genesis-bookman.encrypt",      //私钥备份文件名称。命令执行后，会在项目根目录下生成同名私钥备份文件
  }, 
  "sig": "*"
}
```

**盟友从盟主处获取该文件后，改名为 testnet-genesis.encrypt 并置于主力节点项目根目录下，携带备份密码参数启动节点，利用该私钥备份文件正确设置根私钥**

### 生成信道密钥

Post Input

```json
{
  "method": "sys.aliance.gettoken", //命令字：生成信道密钥
  "wid": "primary",                 //钱包编号，固定为"primary"
  "params": [
    1,                              //联盟节点编号(Int)。同一个联盟成员可能运行多个节点，需要对节点统一编号
    "aliancename",                  //(可选)联盟名称。如果置空，表示生成盟主自身的信道密钥
  ]
}
```

**此命令只在盟主主力节点上执行，在其它节点上执行无意义**

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {
    "aliancename": "bookman",       //联盟名称
    "sn": 1,                        //联盟编号
    "prv": "*",                     //信道密钥的私钥
    "pub": "*",                     //信道密钥的公钥
    "address": "*"                  //信道密钥对应地址
  },
}
```

**返回值中的'信道密钥的私钥'用于[设置信道密钥]命令中。盟友节点信道密钥可自行生成，无需盟主分发**

### 设置信道密钥

Post Input

```json
{
  "method": "sys.aliance.settoken", //命令字：设置信道密钥
  "wid": "primary",                 //钱包编号，固定为"primary"
  "params": [
    "prvKey",                       //(可选)信道密钥的私钥。如果留空，则返回先前设置的密钥，如先前未设置，返回错误码-1
  ]
}
```

**盟友节点自行生成一致的信道密钥后，执行此命令设置自身信道密钥**

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {
    "prv": "*",                     //信道密钥的私钥
    "pub": "*",                     //信道密钥的公钥
    "address": "*"                  //信道密钥对应地址
  },
}
```

### 添加可信信道

Post Input

```json
{
  "method": "sys.aliance.addpeer",  //命令字：添加可信信道
  "wid": "primary",                 //钱包编号，固定为"primary"
  "params": [
    "host",                         //信道的主机地址(IP:PORT)。这里信道指当前节点信任的盟友节点
    "pubKey",                       //信道密钥的公钥
  ]
}
```

**第三方节点和当前节点在正确设置自身信道密钥且相互添加为可信信道后，才能彼此顺利组网**

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {
    "host": "127.0.0.1:2100",     //信道的主机地址
    "key": "*"                    //信道密钥的公钥
  },
}
```

### 查看可信信道

Post Input

```json
{
  "method": "sys.aliance.getpeer",  //命令字：查看可信信道
  "wid": "primary",                 //钱包编号，固定为"primary"
  "params": [
  ]
}
```

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {
      "peer": [],   //可信信道
      "key": [],    //可信公钥
  }
}
```

### 删除可信信道

Post Input

```json
{
  "method": "sys.aliance.delpeer",  //命令字：删除可信信道
  "wid": "primary",                 //钱包编号，固定为"primary"
  "params": [
    "host",                         //信道的主机地址(IP:PORT)
  ]
}
```

**删除HOST相关的Peer记录时，同时会删除相关的Key记录**

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {
    "host": "127.0.0.1:2100",     //信道的主机地址
    "key": "*"                    //信道密钥的公钥
  },
}
```

### 查看选举地址

Post Input

```json
{
  "method": "miner.getaddr.admin",  //命令字：查看选举地址
  "wid": "primary",                 //钱包编号，固定为"primary"
  "params": [
  ]
}
```

**盟友主力节点查看后公布此地址，等待他人选举。盟友辅助节点统一将选举地址设为和主力节点一致**
**盟主节点天然具备记账权，不需要通过选举获得记账权，也不需要公布自己的选举地址**

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {"address": "node.address"}, //盟友节点的选举地址，同时也是记账奖励接收地址
}
```

### 设置选举地址

**请不要轻易调用此命令**

Post Input

```json
{
  "method": "miner.setaddr.admin",  //命令字：设置选举地址
  "wid": "primary",                 //钱包编号，固定为"primary"
  "params": [
    "node.address",                 //盟友主力节点的选举地址，同时也是该组织统一的记账奖励接收地址
  ]
}
```

**盟友主力节点查看后公布此地址，等待他人选举。盟友辅助节点统一将选举地址设为和主力节点一致**
**盟主节点天然具备记账权，不需要通过选举获得记账权，也不需要公布自己的选举地址**

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": null,
}
```

### 选举节点

**选举结果需要经过一个周期后才能生效**

Post Input

```json
{
  "method": "vote.send",    //命令字：选举节点
  "wid": "primary",         //钱包编号，固定为"primary"
  "params": [
    "node.address",         //盟友公布的统一的选举地址
    100000000,              //投票动用的通证金额
  ]
}
```

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {
    "hash": "*",                      //记录所在交易的哈希值
    "height": -1,                     //选举记录链上位置，-1表示尚未上链
    "block": null,                    //选举记录所在区块哈希，NULL表示尚未上链
    "date": "2020-11-19T16:02:02Z",   //选举记录产生时间
    "confirmations": 0,               //确认数，为0表示尚未确认(尚未上链)
    "tx": "*"                         //记录所在交易的原始数据
  },
  "sig": "*"
}
```

### 选举验证

Post Input

```json
{
  "method": "vote.check",   //命令字：选举验证
  "wid": "primary",         //钱包编号，固定为"primary"
  "params": [
    "node.address",         //待验证的选举地址
  ]
}
```

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {
    "address": "tb1q9vw3vdf0jnscl0upkeksuk8t5lfzeg7ztpxlt7",  //选举地址
    "rank": 2,                                                //排名
    "vote": 21000,                                            //票数
    "result": true,                                           //是否当选
    "block": 11                                               //累计记账数
  },
  "sig": "*"
}
```

### 设置矿机运行模式

Post Input

```json
{
  "method": "miner.set.admin",  //命令字：设置矿机运行模式
  "wid": "primary",             //钱包编号，固定为"primary"
  "params": [
    true,                       //指定矿机模式 true 自动记账 false 手动记账
  ]
}
```

Post Output

```json
{
  "code": 0,
  "error": null,
  "result": {
    "mode": true,             //矿机当前运行模式
  },
}
```

## 对等网络配置说明

```bash
# 使用如下指令运行节点，指定其子网类型为'testnet', 数据目录为'~/.gamegold/testnet'
node bin/node --network=testnet
```

通过上述指令，可以为[testnet]子网部署一个默认节点，其项目根目录为'~/.gamegold/testnet'. 
通过切换[--network]参数，可以在单台服务器上，部署多个子网类型不同的对等网络。

### 同一条链多个节点的部署

```bash
# 使用如下指令运行节点，指定其子网类型为'testnet', 数据目录为'~/.gamegold/testnet2', 端口设置偏移量50
node bin/node --port-offset=50 --prefix=~/.gamegold/testnet2 --network=testnet
```

通过上述指令，可以为[testnet]子网部署一个新的节点，其数据目录为'~/.gamegold/testnet2'
通过切换[--prefix]参数，可以在单台服务器上，为指定子网部署任意多个节点

### 节点间对等连接

A节点做如下配置
```conf
# Only try to connect to these nodes.
only:
# P2P网络的基础TCP服务 Local Host & Port (to listen on)
host: ::
```

B节点做如下配置
```conf
# Only try to connect to these nodes.
only: [127.0.0.1]:2100
# P2P网络的基础TCP服务 Local Host & Port (to listen on)
host: ::
port: 2150
```

先后运行A节点和B节点，两者可自动组网。也可以在B节点启动时携带 --only 参数，起到相同的作用

### 节点网络端口

默认网络端口基准值为 2000, 每个不同的子网类型都有一个非零偏移量，以100为单位。例如 testnet 子网的端口基准值就是 2100

| Name        | Type    | Presence | Description                                                   |
|-------------|---------|----------------------------|---------------------------------------------|
| port        | number  | 端口基准值 + 端口偏移量      |  对等网络通讯端口                            |
| httpPort    | number  | 端口基准值 + 端口偏移量 + 2  |  RPC端口                                    |
| wsport      | number  | 端口基准值 + 端口偏移量 + 4  |  WebSocket通讯端口                          |
| stratumPort | number  | 端口基准值 + 端口偏移量 + 5  |  矿机协议通讯端口                            |

## 单元测试

详见 test/节点选举.js

注：使用Mocha进行单元测试时，执行如下指令:

```bash
# 安装Mocha(如果尚未安装)
npm i mocha@5.2.0 -g
# 运行单元测试
mocha test/节点选举
```

## FAQ
