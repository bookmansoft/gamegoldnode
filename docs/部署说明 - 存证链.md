# 存证链部署说明

《百谷王链》是集成了新型密码学的分布式数据库软件，同时支持公链/许可链模式

常见的联盟链/私链都属于许可链，许可链和公链的差异性体现在如下几点：
1. 在许可链上，新的节点要成为目标对等网络的组成节点，需要持有许可链治理机构颁发的节点证书，或者通过社区选举得到节点证书
2. 在许可链上，对等节点间通讯需要加密，防止数据外泄
3. 许可链节点数量相对较少，交易速度要求较高

意愿存证链是典型的联盟链，遵循上述基本原则，部署步骤如下:

1. 部署盟主节点
盟主节点是指定存证链的第一个节点，该节点将确定一系列共识基础，输出供后续节点使用的共识参数
盟主节点部署成功后，也就意味着指定存证链正式运行

2. 部署联盟节点
依次启动各个联盟节点，通过合理配置，使得所有节点自动组成一个对等网络，作为指定存证链的底层设施

注：顶层服务提供商可以考虑实现一个配套的网管系统，调度管理所有节点

## 部署盟主节点

```bash
node bin/node --bip150=true --bip151=true --genesis --network=testnet
```

启动参数说明：
| Name        | Type    | Presence | Description                                                   |
|-------------|---------|----------|---------------------------------------------------------------|
| genesis     | bool    | required | 数值一定为true，指示正在开启一个创世流程                         |
| network     | string  | optional | 指示归属子网类型, 默认为'main'                                  |
| phrase      | string  | optional | 代表钱包根私钥备份解密密钥                                      |
| bip150      | bool    | required | 指示启动节点授权认证                                            |
| bip151      | bool    | required | 指示启动流式加密通讯                                            |

[盟主节点]带[genesis]参数首次启动后，会在根目录下生成创世参数文件 `testnet-genesis.params`，其它组网节点首次启动前，必须将其置于项目根目录下，这样启动后才能生成和盟主节点完全一致的创世节点，这是顺利组网的前提条件

[盟主节点]启动后，会在根目录下生成 `testnet-genesis.encrypt` 创世密钥文件，必须本人妥善保管，不得外泄

[盟主节点]使用[network]参数规定子网类型，子网类型相同的节点组成一个特定对等网络(称之为链态)，因此子网类型决定节点归属。本期项目测试阶段使用子网类型'testnet'，实际部署使用子网类型'evidence' 
如果项目先后以多种子网类型运行，将会在[.gamegold]目录下形成多个子网类型数据目录
本地调测节点期间，如需删库操作，可以关闭节点、整体删除指定子网类型数据目录、再重新运行节点以生成全新数据目录，但务请如果该

[盟主节点]启动后调用如下命令查看己方组网令牌：

Input

```bash
vc sys.aliance.settoken
```

Output

```json
{
    "prv": "77fd3beec28d0eb2b9aeaa0d67dc07251403849891451282ed563dc7176221e9",      //令牌私钥
    "pub": "02de18b045d45b310ce683b4bb8f9936c29f34520c5f868e9359bac280c9b67cd8",    //令牌公钥
    "address": "tb1qegxh996mj26r72xl4tqpu38rhjpwpyuj3gu7gr"                         //令牌地址
}
```

必须将节点地址(host, 例如 127.0.0.1:2100)、令牌公钥(pubkey)分享给其它联盟节点，其它联盟节点分别执行如下命令来为其开放连接:

```bash
sys.aliance.addpeer host pubkey 
```

联盟节点如需升级为记账节点，还需公布令牌地址供其它节点选举

**盟主节点也必须执行上述命令，完成对联盟节点的认证**

## 部署后续节点

启动参数说明：
| Name        | Type    | Presence | Description                                                   |
|-------------|---------|----------|---------------------------------------------------------------|
| genesis     | bool    | optional | 数值一定为true，指示正在跟从一个创世流程                         |
| network     | string  | optional | 指示归属子网类型, 默认为'main'                                  |
| phrase      | string  | optional | 代表钱包根私钥备份解密密钥                                      |
| bip150      | bool    | optional | 指示启动节点授权认证                                            |
| bip151      | bool    | optional | 指示启动流式加密通讯                                            |
| only        | string  | optional | 指示盟主节点主机地址，如 127.0.0.1:2100                           |
| port-offset | number  | optional | 指示监听端口偏移量，用于单机多节点部署                            |
| prefix      | number  | optional | 指示数据目录存储路径，默认为 .gamegold/{子网类型}                 |

[后续节点]启动时必须带 --genesis 参数，系统检测到该参数后，会尝试读取根目录下的 `test-genesis.params` 创世参数文件以构造对应的创世区块，该文件是目标链态的[盟主节点]生产创世区块时转储的创世参数文件，两者必须完全匹配，节点间方能实现同步。
[后续节点]启动时的 --network 参数必须与盟主节点保持一致
[后续节点]启动时需要携带 --only 参数以指定盟主节点地址(例如 127.0.0.1:2100)
[后续节点]如果在单台物理机上做多个部署，需要携带 --port-offset 参数指定监听端口偏移量(10、20...90)以区分不同节点

## 联盟节点开放服务接口

按照《使用手册》远程过程调用的说明，按需调用节点的服务接口，以[查询链态高度]为例：

Post Input

```json
{
  "method": "block.tips",   //命令字：查询链态高度
  "wid": "primary",         //钱包编号，默认"primary"
  "params": [
  ]
}
```

Post Output

```json
{
    "code": 0,                    //返回码，零表示正常
    "error": null,                //错误信息，NULL表示正常
    "result": [
        {
            "height": 139,        //最新区块高度
            "hash": "*",          //最新区块哈希
            "status": "active"    //分支状态
        }
    ],
    "sig": "*"                    //报文签名
}
```

## 对等网络配置说明

```bash
# 使用如下指令运行节点，指定其子网类型为'testnet', 数据目录为'~/.gamegold/testnet'
node bin/node --network=testnet
```

通过上述指令，可以为[testnet]子网部署一个默认节点，其项目根目录为'~/.gamegold/testnet'. 
通过切换[--network]参数，可以在单台服务器上，部署多个子网类型不同的对等网络。

### 同一条链多个节点的部署

```bash
# 使用如下指令运行节点，指定其子网类型为'testnet', 数据目录为'~/.gamegold/testnet2', 端口设置偏移量50
node bin/node --port-offset=50 --prefix=~/.gamegold/testnet2 --network=testnet
```

通过上述指令，可以为[testnet]子网部署一个新的节点，其数据目录为'~/.gamegold/testnet2'
通过切换[--prefix]参数，可以在单台服务器上，为指定子网部署任意多个节点

### 节点间对等连接

A节点做如下配置
```conf
# Only try to connect to these nodes.
only:
# P2P网络的基础TCP服务 Local Host & Port (to listen on)
host: ::
```

B节点做如下配置
```conf
# Only try to connect to these nodes.
only: [127.0.0.1]:2100
# P2P网络的基础TCP服务 Local Host & Port (to listen on)
host: ::
port: 2150
```

先后运行A节点和B节点，两者可自动组网。也可以在B节点启动时携带 --only 参数，起到相同的作用

### 节点网络端口

默认网络端口基准值为 2000, 每个不同的子网类型都有一个非零偏移量，以100为单位。例如 testnet 子网的端口基准值就是 2100

| Name        | Type    | Presence | Description                                                   |
|-------------|---------|----------------------------|---------------------------------------------|
| port        | number  | 端口基准值 + 端口偏移量      |  对等网络通讯端口                            |
| httpPort    | number  | 端口基准值 + 端口偏移量 + 2  |  RPC端口                                    |
| wsport      | number  | 端口基准值 + 端口偏移量 + 4  |  WebSocket通讯端口                          |
| stratumPort | number  | 端口基准值 + 端口偏移量 + 5  |  矿机协议通讯端口                            |
