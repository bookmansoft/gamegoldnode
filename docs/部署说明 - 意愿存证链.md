# 意愿存证链部署说明 V2.2.1

## 总体部署概述

《百谷王链》是集成了新型密码学的分布式数据库软件，同时支持公链/许可链模式。常见的联盟链/私链都属于许可链，许可链和公链的差异性体现在如下几点：
1. 在许可链上，新的节点要成为目标对等网络的组成节点，需要持有许可链治理机构颁发的节点证书，或者通过社区选举得到节点证书
2. 在许可链上，对等节点间通讯需要加密，防止数据外泄
3. 许可链节点数量相对较少，交易速度要求较高

[意愿存证链]是典型的联盟链，遵循上述基本原则，总体部署安排如下:
1. 部署盟主节点
[意愿存证链]管理方部署的第一个节点，称之为盟主节点，该节点将确定一系列共识基础，并输出[创世参数文件]供盟友节点使用
盟主节点部署成功后，也就意味着[意愿存证链]步入正式运行
2. 部署盟主扩展节点
[意愿存证链]管理方直接部署的除盟主节点外的其它节点，统称之为扩展节点，理论上可以部署任意多个扩展节点。
可以添加一个新的盟友单位，作为这些扩展节点的归属单位，每个扩展节点拥有该归属单位内唯一的正整数型序列号。
3. 添加更多盟友
[意愿存证链]管理方为各个顶级合作方添加对应的盟友单位，这些盟友单位作为各自旗下节点的归属单位。
[意愿存证链]管理方可以实现一个配套的网管系统，调度管理所有节点。
4. 组建对等网络
通过合理配置，使得盟主节点、各盟友旗下节点自动组成一个对等网络，形成[意愿存证链]的基础设施

## 部署盟主节点

```bash
node bin/node --genesis --network=testnet --bip150=true --bip151=true --password=bookmansoft
```

表 - [盟主节点]启动参数说明
| Name        | Type    | Presence | Description                                                     |
|-------------|---------|----------|-----------------------------------------------------------------|
| genesis     | bool    | required | 指示正在开启一个创世流程，内容可以为空或'passphrase,language,bits'  |
| network     | string  | optional | 指示归属子网类型, 默认为'testnet'                                 |
| bip150      | bool    | required | 指示启动节点授权认证                                              |
| bip151      | bool    | required | 指示启动流式加密通讯                                              |
| password    | string  | required | 指示创世节点证书解密密码                                          |

[盟主节点]带[genesis]参数首次启动后，会在根目录下生成[创世参数文件] `testnet-genesis.params`，其它组网节点首次启动前，必须将其置于项目根目录下，这样启动后才能生成和盟主节点完全一致的创世节点，这是顺利组网的前提条件。同时还会在根目录下生成 `testnet-genesis.keystore` 创世节点证书，必须本人妥善保管，不得外泄
[盟主节点]使用[network]参数规定子网类型，子网类型相同的节点组成一个特定对等网络(称之为链态)，因此子网类型决定节点归属。本期项目测试阶段使用子网类型'testnet'，实际部署使用子网类型'evidence' 
如果项目先后以多种子网类型运行，将会在[.gamegold]目录下形成多个子网类型数据目录
本地调测节点期间，如需删库操作，可以关闭节点、整体删除指定子网类型数据目录、再重新运行节点。注意这将损失全部历史数据，运营期间执行类似操作，需要提前做好备份工作。

[盟主节点]启动后，调用[创建节点证书]为各个盟友节点创建节点证书文件，其中包含了节点的根密钥、信道密钥和选举地址参数，并将其自动添加为可信信道
**注：在添加第三方盟友单位之前，可以先创建一个"盟主扩展单位"，来容纳所有直属扩展节点**
[盟主节点]将节点证书分发给各个[盟友节点]，[盟友节点]将其置于项目根目录以便自动导入
[盟主节点]可以随时调用[生成信道密钥]重现自身和盟友节点的信道密钥，以便由管理中台对外提供"列表全部节点信道公钥(pubkey)和节点地址(host, 如 127.0.0.1:2100)"的能力，列表中包括盟主节点自身信息。

## 部署盟友节点

[盟友节点]启动时必须带 --genesis 参数，系统检测到该参数后，会尝试读取根目录下的 `test-genesis.params` 创世参数文件以构造对应的创世区块，该文件是目标链态的[盟主节点]生产创世区块时转储的创世参数文件，两者必须完全匹配，节点间方能实现同步
[盟友节点]启动时携带 --keystore 指定根目录下的[节点证书文件](必须带 --password 参数以携带解密密码)，读取并设置节点根私钥、信道密钥以及选举地址
[盟友节点]启动时的 --network 参数必须与盟主节点保持一致
[盟友节点]启动时需要携带 --seeds 参数以指定种子节点列表(内容由[盟主节点]分发), 启动后将其添加为可信信道，就可以自动组网，彼此间展开端到端加密通信
[盟友节点]还可以依据管理中台提供的可信信道列表，添加或删除更多可信信道
[盟友节点]如果在单台物理机上做多个部署，需要携带 --port-offset 参数指定监听端口偏移量(10、20...90)以区分不同节点

表 - [盟友节点]启动参数说明
| Name        | Type    | Presence | Description                                                     |
|-------------|---------|----------|-----------------------------------------------------------------|
| genesis     | bool    | required | 指示正在跟随一个创世流程，内容置空                                 |
| network     | string  | optional | 指示归属子网类型, 默认为'testnet'                                 |
| bip150      | bool    | optional | 指示启动节点授权认证                                              |
| bip151      | bool    | optional | 指示启动流式加密通讯                                              |
| seeds       | string  | optional | 指示盟主节点及其扩展节点地址，如 127.0.0.1:2100，支持逗分格式       |
| keystore    | string  | optional | 指示节点证书名                                                   |
| password    | string  | required | 指示节点证书解密密码                                              |
| port-offset | number  | optional | 指示监听端口偏移量，仅用于单机多节点部署模式                        |
| prefix      | number  | optional | 指示数据目录存储路径，默认为 .gamegold/{子网类型}，仅用于单机多节点  |

## 节点选举

[盟主节点]天然拥有记账权，不需要通过投票获取。
[盟主节点]或[盟友节点]都可以调用[选举节点]指令，利用自身通证为各个选举地址投票，票选出下一个周期的记账节点，从而将指定[盟友节点]升级为记账节点
盟友节点可以调用[验证节点]，查看自身或任意选举地址是否当选
确认当选的盟友节点可以运行[设置矿机运行模式]，将节点设置为自动记账，并自动获取记账奖励

可以通过

## 调用节点开放服务接口

按照《接口说明 - 意愿存证链》和《使用手册》远程过程调用的说明，按需调用节点的服务接口

## 对等网络配置说明

```bash
# 使用如下指令运行节点，指定其子网类型为'testnet', 数据目录为'~/.gamegold/testnet'
node bin/node --network=testnet
```

通过上述指令，可以为[testnet]子网部署一个默认节点，其项目根目录为'~/.gamegold/testnet'. 
通过切换[--network]参数，可以在单台服务器上，部署多个子网类型不同的对等网络。

### 同一条链多个节点的部署

```bash
# 使用如下指令运行节点，指定其子网类型为'testnet', 数据目录为'~/.gamegold/testnet2', 端口设置偏移量50
node bin/node --port-offset=50 --prefix=~/.gamegold/testnet2 --network=testnet
```

通过上述指令，可以为[testnet]子网部署一个新的节点，其数据目录为'~/.gamegold/testnet2'
通过切换[--prefix]参数，可以在单台服务器上，为指定子网部署任意多个节点

### 节点间对等连接

A节点做如下配置
```conf
# Only try to connect to these nodes.
only:
# P2P网络的基础TCP服务 Local Host & Port (to listen on)
host: ::
```

B节点做如下配置
```conf
# Only try to connect to these nodes.
only: [127.0.0.1]:2100
# P2P网络的基础TCP服务 Local Host & Port (to listen on)
host: ::
port: 2150
```

先后运行A节点和B节点，两者可自动组网。也可以在B节点启动时携带 --only 参数或 --seeds 参数带入对应配置信息

### 节点网络端口

默认网络端口基准值为 2000, 每个不同的子网类型都有一个非零偏移量，以100为单位。例如 testnet 子网的端口基准值就是 2100

| Name        | Type    | Presence | Description                                                   |
|-------------|---------|----------------------------|---------------------------------------------|
| port        | number  | 端口基准值 + 端口偏移量      |  对等网络通讯端口                            |
| spvport     | number  | 端口基准值 + 端口偏移量 + 1  |  SPV节点/Wallet节点RPC端口                   |
| httpPort    | number  | 端口基准值 + 端口偏移量 + 2  |  RPC端口                                    |
| wsport      | number  | 端口基准值 + 端口偏移量 + 4  |  WebSocket通讯端口                          |
| stratumPort | number  | 端口基准值 + 端口偏移量 + 5  |  矿机协议通讯端口                            |


## FAQ
